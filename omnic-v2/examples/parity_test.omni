// ============================================================================
// PARITY TEST - Same Logic, Multiple Targets
// Tests Hollow Core with std.http and std.fs
// ============================================================================

// Entity definition
@entity
struct User {
    id: i64,
    name: string,
    email: string
}

// Capsule with server flows
capsule UserService {
    let users: User[] = [];
    
    @server.get("/api/users")
    flow list() -> User[] {
        return users;
    }
    
    @server.get("/api/users/:id")
    flow get_by_id(id: i64) -> User {
        // std.fs - read from cache
        let cached = std.fs.read_file("cache/user_" + id + ".json");
        if (cached != "") {
            return std.json.parse(cached);
        }
        
        // Fallback: find in memory
        for (user in users) {
            if (user.id == id) {
                return user;
            }
        }
        
        return {};
    }
    
    @server.post("/api/users")
    flow create(name: string, email: string) -> User {
        let user = User {
            id: std.time.now(),
            name: name,
            email: email
        };
        
        // Save to cache
        std.fs.write_file(
            "cache/user_" + user.id + ".json",
            std.json.stringify(user)
        );
        
        // Add to memory
        push(users, user);
        
        return user;
    }
}

// HTTP Client example
fn fetch_external_data(url: string) -> any {
    // Uses std.http - translates to:
    // JS: fetch(url).then(r => r.json())
    // Python: requests.get(url).json()
    // C: curl_get(url)
    
    let response = std.http.get(url);
    
    // Logging
    std.io.print("Fetched data from: " + url);
    
    return response;
}

// Crypto example
fn hash_password(password: string) -> string {
    // Uses std.crypto - translates to:
    // JS: crypto.createHash('sha256')...
    // Python: hashlib.sha256(...)
    // C: openssl_sha256(...)
    
    return std.crypto.hash_sha256(password);
}

// Main entry point
fn main() {
    std.io.println("=== Omni Parity Test ===");
    std.io.println("");
    
    // Create user
    let user = UserService.create("John Doe", "john@example.com");
    std.io.println("Created user: " + user.name);
    
    // Fetch external API
    let data = fetch_external_data("https://api.github.com/users/octocat");
    std.io.println("External data loaded");
    
    // Hash a password
    let hashed = hash_password("secret123");
    std.io.println("Password hash: " + hashed);
    
    std.io.println("");
    std.io.println("=== Test Complete ===");
    std.io.println("This same code works on: JS, Python, C Native");
}
