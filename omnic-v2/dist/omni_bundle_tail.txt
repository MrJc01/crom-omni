        // Default ports based on type
        if (node_type === 'function' || node_type === 'flow') {
            node.ports_out.push({ id: 'port_ret_' + new_id, name: 'return', type: 'void' });
        }
        
        graph.nodes.push(node);
    return new_id;
}

function graph_remove_node(graph, node_id) {
graph.nodes = graph.nodes.filter(n => n.id !== node_id);
        
        // Remove connected edges
        graph.edges = graph.edges.filter(e => 
            e.source_node !== node_id && e.target_node !== node_id
        );
        
        // Remove children
        graph.nodes = graph.nodes.filter(n => n.parent_id !== node_id);
}

function graph_move_node(graph, node_id, x, y) {
const node = graph.nodes.find(n => n.id === node_id);
        if (node) {
            const dx = x - node.x;
            const dy = y - node.y;
            node.x = x;
            node.y = y;
            
            // Move children too
            for (const child of graph.nodes) {
                if (child.parent_id === node_id) {
                    child.x += dx;
                    child.y += dy;
                }
            }
        }
}

function graph_add_edge(graph, src_node, src_port, tgt_node, tgt_port) {
    let new_id = "";
new_id = 'edge_' + Date.now();
        
        graph.edges.push({
            id: new_id,
            source_node: src_node,
            source_port: src_port,
            target_node: tgt_node,
            target_port: tgt_port,
            edge_type: 'data'
        });
    return new_id;
}

function graph_remove_edge(graph, edge_id) {
graph.edges = graph.edges.filter(e => e.id !== edge_id);
}


// Auto-exports
if (typeof exports !== 'undefined') {
    exports.VisualGraph_new = VisualGraph_new;
    exports.ast_to_graph = ast_to_graph;
    exports.graph_to_ast = graph_to_ast;
    exports.graph_to_code = graph_to_code;
    exports.graph_to_json = graph_to_json;
    exports.json_to_graph = json_to_graph;
    exports.code_to_graph = code_to_graph;
    exports.get_installed_package_nodes = get_installed_package_nodes;
    exports.graph_add_node = graph_add_node;
    exports.graph_remove_node = graph_remove_node;
    exports.graph_move_node = graph_move_node;
    exports.graph_add_edge = graph_add_edge;
    exports.graph_remove_edge = graph_remove_edge;
    exports.VisualNode = VisualNode;
    exports.VisualEdge = VisualEdge;
    exports.VisualGraph = VisualGraph;
}


// === Module: core/app_packager ===
// Generated by Omni Compiler


var cli = exports;

class AppConfig {
    constructor(data = {}) {
        this.name = data.name;
        this.version = data.version;
        this.icon = data.icon;
        this.description = data.description;
        this.author = data.author;
        this.bundle_id = data.bundle_id;
    }
}

function AppConfig_default() {
    return new AppConfig({ name: "OmniApp", version: "1.0.0", icon: "", description: "Built with Omni", author: "Omni Developer", bundle_id: "org.omni.app" });
}

function detect_platform() {
    let platform = "unknown";
platform = process.platform;
    return platform;
}

function detect_build_tools() {
    let tools = {  };
const { execSync } = require('child_process');
        
        tools = {
            gcc: false,
            clang: false,
            cargo: false,
            android_sdk: false,
            xcode: false,
            wix: false
        };
        
        const check = (cmd) => {
            try {
                execSync(cmd + ' --version', { stdio: 'ignore' });
                return true;
            } catch (e) {
                return false;
            }
        };
        
        tools.gcc = check('gcc');
        tools.clang = check('clang');
        tools.cargo = check('cargo');
        
        // Check for Android SDK
        tools.android_sdk = !!process.env.ANDROID_HOME;
        
        // Check for Xcode (macOS only)
        if (process.platform === 'darwin') {
            tools.xcode = check('xcodebuild');
        }
        
        // Check for WiX (Windows installer)
        if (process.platform === 'win32') {
            tools.wix = check('candle');
        }
    return tools;
}

function generate_tauri_config(config, is_studio) {
    let json = "";
const tauriConfig = {
            "build": {
                "distDir": is_studio ? "../studio/dist" : "../dist",
                "devPath": is_studio ? "http://localhost:3000" : "http://localhost:8080"
            },
            "package": {
                "productName": config.name,
                "version": config.version
            },
            "tauri": {
                "bundle": {
                    "active": true,
                    "icon": ["icons/32x32.png", "icons/128x128.png", "icons/icon.ico"],
                    "identifier": config.bundle_id,
                    "targets": ["msi", "appimage", "dmg"]
                },
                "windows": [{
                    "title": config.name,
                    "width": 1280,
                    "height": 800,
                    "minWidth": 800,
                    "minHeight": 600,
                    "resizable": true,
                    "fullscreen": false
                }],
                "allowlist": {
                    "shell": { "execute": true },
                    "fs": { "all": true },
                    "path": { "all": true },
                    "process": { "all": true },
                    "http": { "all": true }
                }
            }
        };
        
        json = JSON.stringify(tauriConfig, null, 2);
    return json;
}

function generate_capacitor_config(config) {
    let json = "";
const capConfig = {
            "appId": config.bundle_id,
            "appName": config.name,
            "webDir": "dist",
            "server": {
                "androidScheme": "https"
            },
            "plugins": {
                "SplashScreen": {
                    "launchShowDuration": 2000,
                    "backgroundColor": "#0d1117"
                }
            }
        };
        
        json = JSON.stringify(capConfig, null, 2);
    return json;
}

function cmd_package_app(target, config) {
    CLI_banner();
    CLI_header("Omni App Packager");
    CLI_info(("Target: " + target));
    CLI_info(((("App: " + config.name) + " v") + config.version));
    let tools = detect_build_tools();
    let platform = detect_platform();
// const fs = require('fs'); (hoisted)
        // const path = require('path'); (hoisted)
        const { execSync } = require('child_process');
        
        const omniDir = path.join(__dirname, '..');
        const buildDir = path.join(omniDir, 'build');
        const distDir = path.join(omniDir, 'dist', 'app');
        
        // Create build directories
        [buildDir, distDir].forEach(dir => {
            if (!fs.existsSync(dir)) {
                fs.mkdirSync(dir, { recursive: true });
            }
        });
        
        // ================================================================
        // WINDOWS BUILD
        // ================================================================
        if (target === 'windows' || target === 'win32' || target === 'exe') {
            CLI_step(1, 4, "Generating Windows project...");
            
            // Create Tauri project structure
            const tauriDir = path.join(buildDir, 'tauri');
            if (!fs.existsSync(tauriDir)) {
                fs.mkdirSync(tauriDir, { recursive: true });
            }
            
            // Write tauri.conf.json
            const tauriConfig = generate_tauri_config(config, true);
            fs.writeFileSync(path.join(tauriDir, 'tauri.conf.json'), tauriConfig);
            CLI_success("Generated: build/tauri/tauri.conf.json");
            
            CLI_step(2, 4, "Copying Studio UI...");
            
            // Copy Studio files
            const studioDistDir = path.join(tauriDir, 'studio', 'dist');
            if (!fs.existsSync(studioDistDir)) {
                fs.mkdirSync(studioDistDir, { recursive: true });
            }
            
            // Generate minimal index.html that loads Studio
            const indexHtml = `<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><title>${config.name}</title></head>
<body>
<script>
    // Omni Studio loads here
    window.location.href = 'http://localhost:3000';
</script>
</body>
</html>`;
            fs.writeFileSync(path.join(studioDistDir, 'index.html'), indexHtml);
            
            CLI_step(3, 4, "Checking Tauri...");
            
            if (!tools.cargo) {
                CLI_warning("Rust/Cargo not found. Required for Tauri builds.");
                CLI_info("Install Rust: https://rustup.rs/");
                console.log("");
                CLI_info("Manual build steps:");
                console.log(CLI_COLORS.dim + "  cd build/tauri" + CLI_COLORS.reset);
                console.log(CLI_COLORS.dim + "  cargo tauri build" + CLI_COLORS.reset);
                return;
            }
            
            CLI_step(4, 4, "Building...");
            
            console.log("");
            console.log(CLI_COLORS.yellow + "  To complete the Windows build:" + CLI_COLORS.reset);
            console.log("");
            console.log(CLI_COLORS.cyan + "  cd build/tauri" + CLI_COLORS.reset);
            console.log(CLI_COLORS.cyan + "  cargo install tauri-cli" + CLI_COLORS.reset);
            console.log(CLI_COLORS.cyan + "  cargo tauri build" + CLI_COLORS.reset);
            console.log("");
            CLI_success("Windows project ready in build/tauri/");
            return;
        }
        
        // ================================================================
        // ANDROID BUILD
        // ================================================================
        if (target === 'android' || target === 'apk') {
            CLI_step(1, 5, "Generating Capacitor project...");
            
            const capDir = path.join(buildDir, 'capacitor');
            if (!fs.existsSync(capDir)) {
                fs.mkdirSync(capDir, { recursive: true });
            }
            
            // Write capacitor.config.json
            const capConfig = generate_capacitor_config(config);
            fs.writeFileSync(path.join(capDir, 'capacitor.config.json'), capConfig);
            CLI_success("Generated: build/capacitor/capacitor.config.json");
            
            // Create package.json
            const packageJson = {
                "name": config.bundle_id.replace(/\./g, '-'),
                "version": config.version,
                "scripts": {
                    "build": "echo 'Building...'",
                    "cap:add": "npx cap add android",
                    "cap:sync": "npx cap sync",
                    "cap:open": "npx cap open android"
                },
                "dependencies": {
                    "@capacitor/android": "^5.0.0",
                    "@capacitor/core": "^5.0.0",
                    "@capacitor/cli": "^5.0.0"
                }
            };
            fs.writeFileSync(path.join(capDir, 'package.json'), JSON.stringify(packageJson, null, 2));
            
            CLI_step(2, 5, "Creating dist folder...");
            
            const distFolder = path.join(capDir, 'dist');
            if (!fs.existsSync(distFolder)) {
                fs.mkdirSync(distFolder, { recursive: true });
            }
            
            // Create minimal index.html
            const indexHtml = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${config.name}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: system-ui, sans-serif;
            background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container { text-align: center; padding: 20px; }
        h1 { font-size: 2rem; margin-bottom: 1rem; color: #58a6ff; }
        p { color: #8b949e; }
        .btn {
            display: inline-block;
            margin-top: 20px;
            padding: 12px 24px;
            background: #238636;
            color: white;
            border-radius: 8px;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>├óÔÇö┼á ${config.name}</h1>
        <p>Built with Omni</p>
        <a href="#" class="btn" onclick="window.location.reload()">Start</a>
    </div>
</body>
</html>`;
            fs.writeFileSync(path.join(distFolder, 'index.html'), indexHtml);
            
            CLI_step(3, 5, "Checking Android SDK...");
            
            if (!tools.android_sdk) {
                CLI_warning("Android SDK not found (ANDROID_HOME not set)");
                CLI_info("Install Android Studio: https://developer.android.com/studio");
            }
            
            CLI_step(4, 5, "Generating build instructions...");
            
            console.log("");
            console.log(CLI_COLORS.yellow + "  To complete the Android build:" + CLI_COLORS.reset);
            console.log("");
            console.log(CLI_COLORS.cyan + "  cd build/capacitor" + CLI_COLORS.reset);
            console.log(CLI_COLORS.cyan + "  npm install" + CLI_COLORS.reset);
            console.log(CLI_COLORS.cyan + "  npx cap add android" + CLI_COLORS.reset);
            console.log(CLI_COLORS.cyan + "  npx cap sync" + CLI_COLORS.reset);
            console.log(CLI_COLORS.cyan + "  npx cap open android" + CLI_COLORS.reset);
            console.log("");
            
            CLI_step(5, 5, "Done!");
            CLI_success("Android project ready in build/capacitor/");
            return;
        }
        
        // ================================================================
        // LINUX BUILD
        // ================================================================
        if (target === 'linux' || target === 'appimage') {
            CLI_step(1, 3, "Generating Linux project...");
            
            const linuxDir = path.join(buildDir, 'linux');
            if (!fs.existsSync(linuxDir)) {
                fs.mkdirSync(linuxDir, { recursive: true });
            }
            
            // Write desktop file
            const desktopEntry = `[Desktop Entry]
Name=${config.name}
Comment=${config.description}
Exec=omni
Icon=omni
Type=Application
Categories=Development;IDE;
`;
            fs.writeFileSync(path.join(linuxDir, config.name + '.desktop'), desktopEntry);
            
            // Write AppImage recipe
            const appImageYml = `app: ${config.name}
ingredients:
  dist: omni-installer
  script:
    - echo "Building Omni AppImage"

script:
  - mkdir -p AppDir/usr/bin
  - cp omni AppDir/usr/bin/
  - cp -r studio AppDir/usr/share/omni/
`;
            fs.writeFileSync(path.join(linuxDir, 'AppImageBuilder.yml'), appImageYml);
            
            CLI_step(2, 3, "Generated Linux files");
            CLI_step(3, 3, "Done!");
            
            console.log("");
            CLI_info("To build AppImage:");
            console.log(CLI_COLORS.dim + "  cd build/linux" + CLI_COLORS.reset);
            console.log(CLI_COLORS.dim + "  appimage-builder --recipe AppImageBuilder.yml" + CLI_COLORS.reset);
            
            CLI_success("Linux project ready in build/linux/");
            return;
        }
        
        // Unknown target
        CLI_error("Unknown target: " + target);
        CLI_info("Available targets: windows, android, linux");
}


// Auto-exports
if (typeof exports !== 'undefined') {
    exports.AppConfig_default = AppConfig_default;
    exports.detect_platform = detect_platform;
    exports.detect_build_tools = detect_build_tools;
    exports.generate_tauri_config = generate_tauri_config;
    exports.generate_capacitor_config = generate_capacitor_config;
    exports.cmd_package_app = cmd_package_app;
    exports.AppConfig = AppConfig;
}


// === Module: core/tui ===
// Generated by Omni Compiler


var cli = exports;

class TUIState {
    constructor(data = {}) {
        this.screen = data.screen;
        this.cursor = data.cursor;
        this.items = data.items;
        this.selected = data.selected;
        this.message = data.message;
        this.running = data.running;
    }
}

function TUIState_new() {
    return new TUIState({ screen: "main", cursor: 0, items: [], selected: [], message: "", running: true });
}

function tui_enable_raw_mode() {
if (process.stdin.isTTY) {
            process.stdin.setRawMode(true);
        }
        process.stdin.resume();
        process.stdin.setEncoding('utf8');
}

function tui_disable_raw_mode() {
if (process.stdin.isTTY) {
            process.stdin.setRawMode(false);
        }
}

function tui_clear_screen() {
console.clear();
        process.stdout.write('\x1B[2J\x1B[0f');
}

function tui_move_cursor(row, col) {
process.stdout.write(`\x1B[${row};${col}H`);
}

function tui_hide_cursor() {
process.stdout.write('\x1B[?25l');
}

function tui_show_cursor() {
process.stdout.write('\x1B[?25h');
}

function tui_render_header(title, subtitle) {
const width = process.stdout.columns || 80;
        const line = 'â•'.repeat(width - 2);
        
        console.log(CLI_COLORS.cyan + 'â•”' + line + 'â•—' + CLI_COLORS.reset);
        console.log(CLI_COLORS.cyan + 'â•‘' + CLI_COLORS.reset + 
                    CLI_COLORS.bold + ' â—Š OMNI ' + title.padEnd(width - 12) + 
                    CLI_COLORS.reset + CLI_COLORS.cyan + 'â•‘' + CLI_COLORS.reset);
        console.log(CLI_COLORS.cyan + 'â•‘' + CLI_COLORS.reset + 
                    CLI_COLORS.dim + '   ' + subtitle.padEnd(width - 6) + 
                    CLI_COLORS.reset + CLI_COLORS.cyan + 'â•‘' + CLI_COLORS.reset);
        console.log(CLI_COLORS.cyan + 'â• ' + line + 'â•£' + CLI_COLORS.reset);
}

function tui_render_menu(state) {
for (let i = 0; i < state.items.length; i++) {
            const item = state.items[i];
            const selected = i === state.cursor;
            const prefix = selected ? CLI_COLORS.cyan + ' â–¶ ' : '   ';
            const suffix = CLI_COLORS.reset;
            
            if (selected) {
                console.log(prefix + CLI_COLORS.bold + item.label + suffix);
            } else {
                console.log(prefix + CLI_COLORS.dim + item.label + suffix);
            }
        }
}

function tui_render_footer(state) {
const width = process.stdout.columns || 80;
        const line = 'â”€'.repeat(width - 2);
        
        console.log('');
        console.log(CLI_COLORS.dim + 'â”Œ' + line + 'â”' + CLI_COLORS.reset);
        
        if (state.message) {
            console.log(CLI_COLORS.dim + 'â”‚ ' + CLI_COLORS.reset + 
                        state.message.padEnd(width - 4) + 
                        CLI_COLORS.dim + ' â”‚' + CLI_COLORS.reset);
        }
        
        console.log(CLI_COLORS.dim + 'â”‚ â†‘/â†“ Navigate   Enter Select   q Quit' + 
                    ''.padEnd(width - 42) + ' â”‚' + CLI_COLORS.reset);
        console.log(CLI_COLORS.dim + 'â””' + line + 'â”˜' + CLI_COLORS.reset);
}

function tui_render_file_list(state) {
console.log('');
        console.log(CLI_COLORS.cyan + '  Select files to convert:' + CLI_COLORS.reset);
        console.log('');
        
        for (let i = 0; i < state.items.length; i++) {
            const item = state.items[i];
            const isSelected = state.selected.includes(i);
            const isCursor = i === state.cursor;
            
            const checkbox = isSelected ? CLI_COLORS.green + '[âœ“]' : CLI_COLORS.dim + '[ ]';
            const prefix = isCursor ? CLI_COLORS.cyan + ' â–¶ ' : '   ';
            
            console.log(prefix + checkbox + CLI_COLORS.reset + ' ' + 
                        (isCursor ? CLI_COLORS.bold : CLI_COLORS.dim) + 
                        item.name + CLI_COLORS.reset);
        }
}

function tui_render_target_select(state) {
console.log('');
        console.log(CLI_COLORS.cyan + '  Select target language:' + CLI_COLORS.reset);
        console.log('');
        
        for (let i = 0; i < state.items.length; i++) {
            const item = state.items[i];
            const isCursor = i === state.cursor;
            
            const prefix = isCursor ? CLI_COLORS.cyan + ' â–¶ ' : '   ';
            const icon = item.icon || 'ðŸŽ¯';
            
            console.log(prefix + icon + ' ' + 
                        (isCursor ? CLI_COLORS.bold : '') + 
                        item.label + CLI_COLORS.reset);
            
            if (isCursor && item.description) {
                console.log('      ' + CLI_COLORS.dim + item.description + CLI_COLORS.reset);
            }
        }
}

function tui_main_menu() {
    return [{ id: "convert", label: "ðŸ”„ Convert Legacy Code", description: "Transform PHP, Java, Python to Omni" }, { id: "install", label: "ðŸ“¦ Install Package", description: "Install from GitHub" }, { id: "studio", label: "ðŸŽ¨ Open Studio", description: "Visual programming environment" }, { id: "build", label: "ðŸ”¨ Build Project", description: "Compile current project" }, { id: "run", label: "â–¶ï¸  Run Project", description: "Execute main file" }, { id: "doctor", label: "ðŸ©º System Doctor", description: "Check installation health" }, { id: "quit", label: "âŒ Quit", description: "" }];
}

function tui_target_menu() {
    return [{ id: "js", label: "JavaScript (Node.js)", icon: "ðŸŸ¨", description: "CommonJS module" }, { id: "python", label: "Python 3", icon: "ðŸ", description: "Python 3.8+ compatible" }, { id: "c", label: "C Native", icon: "âš¡", description: "Portable C99 code" }, { id: "lua", label: "Lua 5.4", icon: "ðŸŒ™", description: "Lua script" }, { id: "wasm", label: "WebAssembly", icon: "ðŸ•¸ï¸", description: "WASM binary" }, { id: "back", label: "â† Back", icon: "â—€ï¸", description: "" }];
}

function tui_scan_legacy_files(dir) {
    let files = [];
// const fs = require('fs'); (hoisted)
        // const path = require('path'); (hoisted)
        
        const extensions = ['.php', '.java', '.py', '.js', '.ts'];
        
        const scan = (d) => {
            try {
                const entries = fs.readdirSync(d, { withFileTypes: true });
                for (const entry of entries) {
                    if (entry.name.startsWith('.') || entry.name === 'node_modules') continue;
                    
                    const fullPath = path.join(d, entry.name);
                    
                    if (entry.isDirectory()) {
                        scan(fullPath);
                    } else if (extensions.some(ext => entry.name.endsWith(ext))) {
                        files.push({
                            name: path.relative(dir, fullPath),
                            path: fullPath,
                            ext: path.extname(entry.name)
                        });
                    }
                }
            } catch (e) {
                // Skip inaccessible directories
            }
        };
        
        scan(dir);
    return files;
}

function cmd_tui() {
    let state = TUIState_new();
state.items = tui_main_menu();
    tui_enable_raw_mode();
    tui_hide_cursor();
const readline = require('readline');
        
        const render = () => {
            tui_clear_screen();
            tui_render_header('INTERACTIVE', 'v1.1.0 - Use arrow keys to navigate');
            
            if (state.screen === 'main') {
                tui_render_menu(state);
            } else if (state.screen === 'files') {
                tui_render_file_list(state);
            } else if (state.screen === 'targets') {
                tui_render_target_select(state);
            }
            
            tui_render_footer(state);
        };
        
        const handleAction = (action) => {
            if (action === 'convert') {
                state.screen = 'files';
                state.items = tui_scan_legacy_files(process.cwd());
                state.cursor = 0;
                state.selected = [];
                state.message = 'Space to select, Enter to continue';
            } else if (action === 'install') {
                state.message = 'Use: omni install github:user/repo';
                setTimeout(() => { state.message = ''; render(); }, 2000);
            } else if (action === 'studio') {
                tui_show_cursor();
                tui_disable_raw_mode();
                console.log('\nStarting Omni Studio...');
                require('child_process').execSync('node dist/main.js studio', { stdio: 'inherit' });
                process.exit(0);
            } else if (action === 'build') {
                tui_show_cursor();
                tui_disable_raw_mode();
                console.log('\nBuilding project...');
                require('child_process').execSync('node dist/main.js build', { stdio: 'inherit' });
                process.exit(0);
            } else if (action === 'run') {
                tui_show_cursor();
                tui_disable_raw_mode();
                console.log('\nRunning project...');
                require('child_process').execSync('node dist/main.js run main.omni', { stdio: 'inherit' });
                process.exit(0);
            } else if (action === 'doctor') {
                tui_show_cursor();
                tui_disable_raw_mode();
                cmd_doctor();
                process.exit(0);
            } else if (action === 'quit') {
                state.running = false;
            } else if (action === 'select_target') {
                state.screen = 'targets';
                state.items = tui_target_menu();
                state.cursor = 0;
                state.message = 'Select output target';
            } else if (action === 'back') {
                state.screen = 'main';
                state.items = tui_main_menu();
                state.cursor = 0;
            } else if (action.startsWith('target:')) {
                const target = action.split(':')[1];
                tui_show_cursor();
                tui_disable_raw_mode();
                console.log('\nConverting ' + state.selected.length + ' files to ' + target + '...');
                // Here would call ingest for each selected file
                process.exit(0);
            }
        };
        
        process.stdin.on('data', (key) => {
            // Handle key presses
            if (key === '\u001B[A') { // Up arrow
                state.cursor = Math.max(0, state.cursor - 1);
            } else if (key === '\u001B[B') { // Down arrow
                state.cursor = Math.min(state.items.length - 1, state.cursor + 1);
            } else if (key === ' ' && state.screen === 'files') { // Space - toggle select
                const idx = state.selected.indexOf(state.cursor);
                if (idx >= 0) {
                    state.selected.splice(idx, 1);
                } else {
                    state.selected.push(state.cursor);
                }
            } else if (key === '\r' || key === '\n') { // Enter
                const item = state.items[state.cursor];
                if (state.screen === 'main') {
                    handleAction(item.id);
                } else if (state.screen === 'files') {
                    if (state.selected.length > 0) {
                        handleAction('select_target');
                    } else {
                        state.message = 'Select at least one file';
                    }
                } else if (state.screen === 'targets') {
                    if (item.id === 'back') {
                        handleAction('back');
                    } else {
                        handleAction('target:' + item.id);
                    }
                }
            } else if (key === 'q' || key === '\u0003') { // q or Ctrl+C
                state.running = false;
            } else if (key === '\u001B' || key === 'b') { // Escape or b - back
                if (state.screen !== 'main') {
                    handleAction('back');
                }
            }
            
            if (state.running) {
                render();
            } else {
                tui_show_cursor();
                tui_disable_raw_mode();
                console.log('\nGoodbye! ðŸ‘‹');
                process.exit(0);
            }
        });
        
        // Initial render
        render();
}

function tui_quick_convert(files, target) {
console.log(CLI_COLORS.cyan + 'â—Š Quick Convert' + CLI_COLORS.reset);
        console.log('');
        
        for (const file of files) {
            console.log(CLI_COLORS.dim + '  Converting: ' + file + CLI_COLORS.reset);
            // Would call ingest here
        }
        
        CLI_success('Conversion complete!');
}



// Auto-exports
if (typeof exports !== 'undefined') {
    exports.TUIState_new = TUIState_new;
    exports.tui_enable_raw_mode = tui_enable_raw_mode;
    exports.tui_disable_raw_mode = tui_disable_raw_mode;
    exports.tui_clear_screen = tui_clear_screen;
    exports.tui_move_cursor = tui_move_cursor;
    exports.tui_hide_cursor = tui_hide_cursor;
    exports.tui_show_cursor = tui_show_cursor;
    exports.tui_render_header = tui_render_header;
    exports.tui_render_menu = tui_render_menu;
    exports.tui_render_footer = tui_render_footer;
    exports.tui_render_file_list = tui_render_file_list;
    exports.tui_render_target_select = tui_render_target_select;
    exports.tui_main_menu = tui_main_menu;
    exports.tui_target_menu = tui_target_menu;
    exports.tui_scan_legacy_files = tui_scan_legacy_files;
    exports.cmd_tui = cmd_tui;
    exports.tui_quick_convert = tui_quick_convert;
    exports.TUIState = TUIState;
}


// === Module: lib/std ===
// Generated by Omni Compiler



function print(msg) {
console.log(msg);

}

function read_file(path) {
    let content = "";
// const fs = require("fs"); (hoisted)
        try {
            content = fs.readFileSync(path, "utf8");
        } catch (e) {
            console.error("Error reading file " + path + ": " + e.message);
            process.exit(1);
        }

    return content;
}

function write_file(path, content) {
// const fs = require("fs"); (hoisted)
        try {
            fs.writeFileSync(path, content);
        } catch (e) {
            console.error("Error writing file " + path + ": " + e.message);
            process.exit(1);
        }

}



// Auto-exports
if (typeof exports !== 'undefined') {
    exports.print = print;
    exports.read_file = read_file;
    exports.write_file = write_file;
}


// === Module: lib/cli ===
// Generated by Omni Compiler



class Colors {
    constructor(data = {}) {
        this.reset = data.reset;
        this.bold = data.bold;
        this.dim = data.dim;
        this.underline = data.underline;
        this.black = data.black;
        this.red = data.red;
        this.green = data.green;
        this.yellow = data.yellow;
        this.blue = data.blue;
        this.magenta = data.magenta;
        this.cyan = data.cyan;
        this.white = data.white;
        this.bg_black = data.bg_black;
        this.bg_red = data.bg_red;
        this.bg_green = data.bg_green;
        this.bg_yellow = data.bg_yellow;
        this.bg_blue = data.bg_blue;
        this.bg_magenta = data.bg_magenta;
        this.bg_cyan = data.bg_cyan;
        this.bg_white = data.bg_white;
    }
}

function Colors_new() {
    let c = new Colors({ reset: "", bold: "", dim: "", underline: "", black: "", red: "", green: "", yellow: "", blue: "", magenta: "", cyan: "", white: "", bg_black: "", bg_red: "", bg_green: "", bg_yellow: "", bg_blue: "", bg_magenta: "", bg_cyan: "", bg_white: "" });
const supportsColor = process.stdout.isTTY && 
            (process.env.TERM !== 'dumb') && 
            !process.env.NO_COLOR;
        
        if (supportsColor) {
            c.reset = '\x1b[0m';
            c.bold = '\x1b[1m';
            c.dim = '\x1b[2m';
            c.underline = '\x1b[4m';
            
            c.black = '\x1b[30m';
            c.red = '\x1b[31m';
            c.green = '\x1b[32m';
            c.yellow = '\x1b[33m';
            c.blue = '\x1b[34m';
            c.magenta = '\x1b[35m';
            c.cyan = '\x1b[36m';
            c.white = '\x1b[37m';
            
            c.bg_black = '\x1b[40m';
            c.bg_red = '\x1b[41m';
            c.bg_green = '\x1b[42m';
            c.bg_yellow = '\x1b[43m';
            c.bg_blue = '\x1b[44m';
            c.bg_magenta = '\x1b[45m';
            c.bg_cyan = '\x1b[46m';
            c.bg_white = '\x1b[47m';
        }
    return c;
}

let CLI_COLORS_INIT = false;

let CLI_COLORS_CACHE = new Colors({ reset: "", bold: "", dim: "", underline: "", black: "", red: "", green: "", yellow: "", blue: "", magenta: "", cyan: "", white: "", bg_black: "", bg_red: "", bg_green: "", bg_yellow: "", bg_blue: "", bg_magenta: "", bg_cyan: "", bg_white: "" });

function CLI_COLORS() {
    if (CLI_COLORS_INIT === false) {
    CLI_COLORS_CACHE = Colors_new();
    CLI_COLORS_INIT = true;
}

    return CLI_COLORS_CACHE;
}

function CLI_success(msg) {
const c = CLI_COLORS();
        console.log(c.green + 'âœ“' + c.reset + ' ' + msg);
}

function CLI_error(msg) {
const c = CLI_COLORS();
        console.error(c.red + 'âœ—' + c.reset + ' ' + msg);
}

function CLI_warning(msg) {
const c = CLI_COLORS();
        console.log(c.yellow + 'âš ' + c.reset + ' ' + msg);
}

function CLI_info(msg) {
const c = CLI_COLORS();
        console.log(c.blue + 'â„¹' + c.reset + ' ' + msg);
}

function CLI_step(step, total, msg) {
const c = CLI_COLORS();
        const prefix = c.cyan + '[' + step + '/' + total + ']' + c.reset;
        console.log(prefix + ' ' + msg);
}

function CLI_header(title) {
const c = CLI_COLORS();
        console.log('');
        console.log(c.bold + c.cyan + 'â•â•â• ' + title + ' â•â•â•' + c.reset);
        console.log('');
}

function CLI_dim(msg) {
    let result = "";
const c = CLI_COLORS();
        result = c.dim + msg + c.reset;
    return result;
}

function CLI_bold(msg) {
    let result = "";
const c = CLI_COLORS();
        result = c.bold + msg + c.reset;
    return result;
}

function CLI_green(msg) {
    let result = "";
const c = CLI_COLORS();
        result = c.green + msg + c.reset;
    return result;
}

function CLI_red(msg) {
    let result = "";
const c = CLI_COLORS();
        result = c.red + msg + c.reset;
    return result;
}

function CLI_yellow(msg) {
    let result = "";
const c = CLI_COLORS();
        result = c.yellow + msg + c.reset;
    return result;
}

function CLI_cyan(msg) {
    let result = "";
const c = CLI_COLORS();
        result = c.cyan + msg + c.reset;
    return result;
}

class Spinner {
    constructor(data = {}) {
        this.frames = data.frames;
        this.current = data.current;
        this.interval = data.interval;
        this.message = data.message;
        this.running = data.running;
    }
}

function Spinner_new(message) {
    let spinner = new Spinner({ frames: "â ‹â ™â ¹â ¸â ¼â ´â ¦â §â ‡â ", current: 0, interval: 0, message: message, running: false });
    return spinner;
}

function Spinner_start(self) {
if (self.running) return;
        self.running = true;
        const frames = self.frames.split('');
        const c = CLI_COLORS();
        
        self.interval = setInterval(() => {
            process.stdout.write('\r' + c.cyan + 
                frames[self.current % frames.length] + c.reset + 
                ' ' + self.message);
            self.current = (self.current + 1) % frames.length;
        }, 80);
}

function Spinner_stop(self, success) {
if (!self.running) return;
        
        clearInterval(self.interval);
        self.running = false;
        const c = CLI_COLORS();
        
        const icon = success 
            ? c.green + 'âœ“' + c.reset 
            : c.red + 'âœ—' + c.reset;
        
        process.stdout.write('\r' + icon + ' ' + self.message + '\n');
}

function CLI_progress_bar(current, total, width) {
    let result = "";
const c = CLI_COLORS();
        const percent = Math.floor((current / total) * 100);
        const filled = Math.floor((current / total) * width);
        const empty = width - filled;
        
        const bar = c.green + 'â–ˆ'.repeat(filled) + 
                    c.dim + 'â–‘'.repeat(empty) + c.reset;
        
        result = bar + ' ' + percent + '%';
    return result;
}

class ParsedArgs {
    constructor(data = {}) {
        this.command = data.command;
        this.arg1 = data.arg1;
        this.arg2 = data.arg2;
        this.arg3 = data.arg3;
        this.flag_help = data.flag_help;
        this.flag_version = data.flag_version;
        this.flag_verbose = data.flag_verbose;
        this.flag_global = data.flag_global;
        this.flag_app = data.flag_app;
        this.flag_tui = data.flag_tui;
        this.opt_target = data.opt_target;
        this.opt_port = data.opt_port;
        this.opt_framework = data.opt_framework;
    }
}

function ParsedArgs_new() {
    let args = new ParsedArgs({ command: "", arg1: "", arg2: "", arg3: "", flag_help: false, flag_version: false, flag_verbose: false, flag_global: false, flag_app: false, flag_tui: false, opt_target: "js", opt_port: "3000", opt_framework: "" });
const argv = process.argv.slice(2);
        
        let positional = [];
        for (let i = 0; i < argv.length; i++) {
            const arg = argv[i];
            
            if (arg === '--help' || arg === '-h') {
                args.flag_help = true;
            } else if (arg === '--version' || arg === '-v') {
                args.flag_version = true;
            } else if (arg === '--verbose' || arg === '-V') {
                args.flag_verbose = true;
            } else if (arg === '--global' || arg === '-g') {
                args.flag_global = true;
            } else if (arg === '--app') {
                args.flag_app = true;
            } else if (arg === '--tui') {
                args.flag_tui = true;
            } else if (arg === '--target' && argv[i + 1]) {
                args.opt_target = argv[++i];
            } else if (arg === '--port' && argv[i + 1]) {
                args.opt_port = argv[++i];
            } else if (arg === '--framework' && argv[i + 1]) {
                args.opt_framework = argv[++i];
            } else if (!arg.startsWith('-')) {
                positional.push(arg);
            }
        }
        
        args.command = positional[0] || '';
        args.arg1 = positional[1] || '';
        args.arg2 = positional[2] || '';
        args.arg3 = positional[3] || '';
    return args;
}

function CLI_table_simple(col1, col2) {
const c = CLI_COLORS();
        console.log('  ' + c.cyan + col1.padEnd(20) + c.reset + col2);
}

function CLI_table_header(title) {
const c = CLI_COLORS();
        console.log('');
        console.log(c.bold + title + c.reset);
        console.log('â”€'.repeat(50));
}

function CLI_banner() {
const c = CLI_COLORS();
        console.log('');
        console.log(c.cyan + c.bold + 
            '   ____  __  __ _   _ ___ ' + c.reset);
        console.log(c.cyan + 
            '  / __ \\|  \\/  | \\ | |_ _|' + c.reset);
        console.log(c.cyan + 
            ' | |  | | |\\/| |  \\| || | ' + c.reset);
        console.log(c.cyan + 
            ' | |__| | |  | | |\\  || | ' + c.reset);
        console.log(c.cyan + 
            '  \\____/|_|  |_|_| \\_|___|' + c.reset);
        console.log('');
        console.log(c.dim + 
            '  Hybrid Metamorphosis Compiler' + c.reset);
        console.log('');
}

function CLI_version() {
    return "1.2.0";
}



// Auto-exports
if (typeof exports !== 'undefined') {
    exports.Colors_new = Colors_new;
    exports.CLI_COLORS = CLI_COLORS;
    exports.CLI_success = CLI_success;
    exports.CLI_error = CLI_error;
    exports.CLI_warning = CLI_warning;
    exports.CLI_info = CLI_info;
    exports.CLI_step = CLI_step;
    exports.CLI_header = CLI_header;
    exports.CLI_dim = CLI_dim;
    exports.CLI_bold = CLI_bold;
    exports.CLI_green = CLI_green;
    exports.CLI_red = CLI_red;
    exports.CLI_yellow = CLI_yellow;
    exports.CLI_cyan = CLI_cyan;
    exports.Spinner_new = Spinner_new;
    exports.Spinner_start = Spinner_start;
    exports.Spinner_stop = Spinner_stop;
    exports.CLI_progress_bar = CLI_progress_bar;
    exports.ParsedArgs_new = ParsedArgs_new;
    exports.CLI_table_simple = CLI_table_simple;
    exports.CLI_table_header = CLI_table_header;
    exports.CLI_banner = CLI_banner;
    exports.CLI_version = CLI_version;
    exports.Colors = Colors;
    exports.Spinner = Spinner;
    exports.ParsedArgs = ParsedArgs;
    exports.CLI_COLORS_INIT = CLI_COLORS_INIT;
    exports.CLI_COLORS_CACHE = CLI_COLORS_CACHE;
}


// === Main Entry ===
// Generated by Omni Compiler


var token = exports;
var lexer = exports;
var parser = exports;
var codegen_hybrid = exports;
var vm = exports;
var framework_adapter = exports;
var ingestion = exports;
var package_manager = exports;
var contracts = exports;
var ghost_writer = exports;
var bootstrap = exports;
var studio_engine = exports;
var studio_graph = exports;
var app_packager = exports;
var tui = exports;
var std = exports;
var cli = exports;

function get_omni_home() {
    let home = "";
// const path = require('path'); (hoisted)
        // const os = require('os'); (hoisted)
        
        // Priority 1: OMNI_HOME environment variable
        if (process.env.OMNI_HOME) {
            home = process.env.OMNI_HOME;
        }
        // Priority 2: Executable directory
        else if (__dirname) {
            home = path.dirname(__dirname);
        }
        // Priority 3: User's home directory
        else {
            const platform = os.platform();
            if (platform === 'win32') {
                home = path.join(os.homedir(), 'AppData', 'Local', 'Omni');
            } else {
                home = path.join(os.homedir(), '.local', 'share', 'omni');
            }
        }
    return home;
}

function resolve_resource_path(name) {
    let resolved = "";
// const fs = require('fs'); (hoisted)
        // const path = require('path'); (hoisted)
        
        // Strategy 1: Local project path (./targets/, ./packages/, ./patterns/)
        const localPath = path.join(process.cwd(), name);
        if (fs.existsSync(localPath)) {
            resolved = localPath;
            return;
        }
        
        // Strategy 2: Relative to executable (dist/../)
        const execPath = path.join(__dirname, '..', name);
        if (fs.existsSync(execPath)) {
            resolved = execPath;
            return;
        }
        
        // Strategy 3: OMNI_HOME
        const omniHome = get_omni_home();
        const homePath = path.join(omniHome, name);
        if (fs.existsSync(homePath)) {
            resolved = homePath;
            return;
        }
        
        // Strategy 4: Global installation
        // const os = require('os'); (hoisted)
        const platform = os.platform();
        let globalPath;
        
        if (platform === 'win32') {
            globalPath = path.join(os.homedir(), 'AppData', 'Local', 'Omni', name);
        } else {
            globalPath = path.join(os.homedir(), '.local', 'share', 'omni', name);
        }
        
        if (fs.existsSync(globalPath)) {
            resolved = globalPath;
            return;
        }
        
        // Not found - return local path for error messages
        resolved = localPath;
    return resolved;
}

function cmd_setup(is_global) {
    CLI_banner();
    CLI_header("Omni Setup");
// const os = require('os'); (hoisted)
        // const fs = require('fs'); (hoisted)
        // const path = require('path'); (hoisted)
        const { execSync } = require('child_process');
        
        const platform = os.platform();
        const isWindows = platform === 'win32';
        const omniDir = path.dirname(path.dirname(__filename));
        
        CLI_info("Platform: " + platform + " (" + os.arch() + ")");
        CLI_info("Omni directory: " + omniDir);
        CLI_info("Mode: " + (is_global ? "GLOBAL" : "LOCAL"));
        
        console.log("");
        
        if (is_global) {
            // ============================================================
            // GLOBAL INSTALLATION
            // ============================================================
            CLI_step(1, 4, "Detecting global installation path...");
            
            let globalDir;
            if (isWindows) {
                // Windows: Use %AppData%\Omni
                globalDir = path.join(os.homedir(), 'AppData', 'Local', 'Omni');
            } else {
                // Unix: Use ~/.local/bin or /usr/local/bin
                globalDir = path.join(os.homedir(), '.local', 'share', 'omni');
            }
            
            CLI_info("Global directory: " + globalDir);
            
            CLI_step(2, 4, "Copying Omni files...");
            
            // Ensure directory exists
            if (!fs.existsSync(globalDir)) {
                fs.mkdirSync(globalDir, { recursive: true });
            }
            
            // Copy dist folder
            const srcDist = path.join(omniDir, 'dist');
            const dstDist = path.join(globalDir, 'dist');
            
            if (fs.existsSync(srcDist)) {
                if (!fs.existsSync(dstDist)) {
                    fs.mkdirSync(dstDist, { recursive: true });
                }
                
                const files = fs.readdirSync(srcDist);
                for (const file of files) {
                    fs.copyFileSync(
                        path.join(srcDist, file),
                        path.join(dstDist, file)
                    );
                }
                CLI_success("Copied " + files.length + " files");
            }
            
            // Copy lib folder
            const srcLib = path.join(omniDir, 'src', 'lib');
            const dstLib = path.join(globalDir, 'lib');
            
            if (fs.existsSync(srcLib)) {
                if (!fs.existsSync(dstLib)) {
                    fs.mkdirSync(dstLib, { recursive: true });
                }
                
                const walkAndCopy = (src, dst) => {
                    const entries = fs.readdirSync(src, { withFileTypes: true });
                    for (const entry of entries) {
                        const srcPath = path.join(src, entry.name);
                        const dstPath = path.join(dst, entry.name);
                        if (entry.isDirectory()) {
                            if (!fs.existsSync(dstPath)) fs.mkdirSync(dstPath);
                            walkAndCopy(srcPath, dstPath);
                        } else {
                            fs.copyFileSync(srcPath, dstPath);
                        }
                    }
                };
                walkAndCopy(srcLib, dstLib);
                CLI_success("Copied standard library");
            }
            
            CLI_step(3, 4, "Creating executable wrapper...");
            
            if (isWindows) {
                // Windows: Create batch and PowerShell wrappers
                const cmdContent = `@echo off
node "%~dp0dist\\main.js" %*`;
                fs.writeFileSync(path.join(globalDir, 'omni.cmd'), cmdContent);
                
                const ps1Content = `#!/usr/bin/env pwsh
node "$PSScriptRoot\\dist\\main.js" @args`;
                fs.writeFileSync(path.join(globalDir, 'omni.ps1'), ps1Content);
                
                CLI_success("Created omni.cmd and omni.ps1");
            } else {
                // Unix: Create shell script
                const shContent = `#!/usr/bin/env bash
OMNI_DIR="$( cd "$( dirname "\${BASH_SOURCE[0]}" )" && pwd )"
node "$OMNI_DIR/dist/main.js" "$@"`;
                const shPath = path.join(globalDir, 'omni');
                fs.writeFileSync(shPath, shContent);
                fs.chmodSync(shPath, '755');
                
                CLI_success("Created omni executable");
            }
            
            CLI_step(4, 4, "Configuring PATH...");
            
            let binDir;
            if (isWindows) {
                binDir = globalDir;
                
                // Try to add to user PATH
                try {
                    const currentPath = execSync('echo %PATH%', { encoding: 'utf-8' }).trim();
                    if (!currentPath.includes(globalDir)) {
                        console.log("");
                        CLI_warning("Add this directory to your PATH:");
                        console.log(CLI_COLORS.cyan + "  " + globalDir + CLI_COLORS.reset);
                        console.log("");
                        console.log(CLI_COLORS.dim + "  PowerShell (admin):" + CLI_COLORS.reset);
                        console.log(CLI_COLORS.dim + "  [Environment]::SetEnvironmentVariable('Path', $env:Path + ';' + '" + globalDir + "', 'User')" + CLI_COLORS.reset);
                    } else {
                        CLI_success("Already in PATH");
                    }
                } catch (e) {}
            } else {
                binDir = path.join(os.homedir(), '.local', 'bin');
                
                // Create symlink in ~/.local/bin
                if (!fs.existsSync(binDir)) {
                    fs.mkdirSync(binDir, { recursive: true });
                }
                
                const linkPath = path.join(binDir, 'omni');
                try {
                    if (fs.existsSync(linkPath)) fs.unlinkSync(linkPath);
                    fs.symlinkSync(path.join(globalDir, 'omni'), linkPath);
                    CLI_success("Linked: " + linkPath);
                } catch (e) {
                    CLI_warning("Could not create symlink: " + e.message);
                }
                
                // Check if ~/.local/bin is in PATH
                const shellPath = process.env.PATH || '';
                if (!shellPath.includes(binDir)) {
                    console.log("");
                    CLI_warning("Add to your shell profile (~/.bashrc or ~/.zshrc):");
                    console.log(CLI_COLORS.cyan + '  export PATH="$HOME/.local/bin:$PATH"' + CLI_COLORS.reset);
                }
            }
            
            console.log("");
            CLI_success("Global installation complete!");
            console.log("");
            console.log(CLI_COLORS.green + "  Try: omni --version" + CLI_COLORS.reset);
            
        } else {
            // ============================================================
            // LOCAL INSTALLATION (./omni in current project)
            // ============================================================
            CLI_step(1, 2, "Creating local wrapper...");
            
            const cwd = process.cwd();
            
            if (isWindows) {
                const cmdContent = `@echo off
node "${path.join(omniDir, 'dist', 'main.js')}" %*`;
                fs.writeFileSync(path.join(cwd, 'omni.cmd'), cmdContent);
                CLI_success("Created: omni.cmd");
            } else {
                const shContent = `#!/usr/bin/env bash
node "${path.join(omniDir, 'dist', 'main.js')}" "$@"`;
                const shPath = path.join(cwd, 'omni');
                fs.writeFileSync(shPath, shContent);
                fs.chmodSync(shPath, '755');
                CLI_success("Created: ./omni");
            }
            
            CLI_step(2, 2, "Done!");
            
            console.log("");
            CLI_success("Local installation complete!");
            console.log("");
            if (isWindows) {
                console.log(CLI_COLORS.green + "  Try: .\\omni.cmd --version" + CLI_COLORS.reset);
            } else {
                console.log(CLI_COLORS.green + "  Try: ./omni --version" + CLI_COLORS.reset);
            }
        }
}

function cmd_version() {
    CLI_banner();
    print("Version: " + CLI_version());
    print("");
console.log(CLI_COLORS.dim + "Node.js: " + process.version + CLI_COLORS.reset);
        console.log(CLI_COLORS.dim + "Platform: " + process.platform + CLI_COLORS.reset);
        console.log(CLI_COLORS.dim + "Arch: " + process.arch + CLI_COLORS.reset);
}

function cmd_package_self() {
    CLI_header("Self-Package");
// const fs = require('fs'); (hoisted)
        // const path = require('path'); (hoisted)
        const { execSync } = require('child_process');
        
        const omniDir = path.dirname(path.dirname(__filename));
        const version = CLI_version();
        const platform = process.platform;
        
        CLI_step(1, 4, "Collecting source files...");
        
        // Files to include
        const distDir = path.join(omniDir, 'dist');
        const targetsDir = path.join(omniDir, 'targets');
        
        CLI_step(2, 4, "Creating package manifest...");
        
        const manifest = {
            name: 'omni-compiler',
            version: version,
            platform: platform,
            created: new Date().toISOString(),
            files: []
        };
        
        // List dist files
        if (fs.existsSync(distDir)) {
            const files = fs.readdirSync(distDir, { recursive: true });
            manifest.files.push(...files.map(f => 'dist/' + f));
        }
        
        // List target profiles
        if (fs.existsSync(targetsDir)) {
            const files = fs.readdirSync(targetsDir);
            manifest.files.push(...files.map(f => 'targets/' + f));
        }
        
        CLI_step(3, 4, "Writing package...");
        
        const packageName = `omni-${version}-${platform}`;
        const packageDir = path.join(omniDir, 'packages');
        
        if (!fs.existsSync(packageDir)) {
            fs.mkdirSync(packageDir, { recursive: true });
        }
        
        // Write manifest
        fs.writeFileSync(
            path.join(packageDir, packageName + '.json'),
            JSON.stringify(manifest, null, 2)
        );
        
        CLI_step(4, 4, "Creating executable wrapper...");
        
        // Create .run file (Unix) or .cmd (Windows)
        if (platform === 'win32') {
            const runContent = `@echo off
set OMNI_HOME=%~dp0
node "%OMNI_HOME%dist\\main.js" %*`;
            fs.writeFileSync(path.join(packageDir, packageName + '.cmd'), runContent);
            CLI_success("Package created: packages/" + packageName + ".cmd");
        } else {
            const runContent = `#!/bin/bash
OMNI_HOME="$(dirname "$(readlink -f "$0")")"
node "$OMNI_HOME/dist/main.js" "$@"`;
            const runPath = path.join(packageDir, packageName + '.run');
            fs.writeFileSync(runPath, runContent);
            fs.chmodSync(runPath, '755');
            CLI_success("Package created: packages/" + packageName + ".run");
        }
        
        console.log("");
        CLI_info("Package manifest: packages/" + packageName + ".json");
        CLI_info("Total files: " + manifest.files.length);
}

function main() {
    let args_len = 0;
args_len = process.argv.length;
    let command = "";
command = process.argv[2] || '';
    if (command === "setup") {
    cmd_setup();
    return 0;
}

    if (((command === "--version" || command) === "-v" || command) === "version") {
    cmd_version();
    return 0;
}

    if (command === "package") {
    let self_package = false;
self_package = process.argv[3] === '--self';
    if (self_package) {
    cmd_package_self();
    return 0;
}

}

    if (command === "setup") {
    let is_global = false;
for (let i = 3; i < process.argv.length; i++) {
                if (process.argv[i] === '--global' || process.argv[i] === '-g') {
                    is_global = true;
                }
            }
    cmd_setup(is_global);
    return 0;
}

    if (command === "install") {
    let package_spec = "";
package_spec = process.argv[3] || '';
    cmd_install(package_spec);
    return 0;
}

    if (command === "uninstall") {
    let package_name = "";
package_name = process.argv[3] || '';
    if (package_name === "") {
    CLI_error("Usage: omni uninstall <package_name>");
    return 1;
}

    cmd_uninstall(package_name);
    return 0;
}

    if (command === "list") {
    cmd_list();
    return 0;
}

    if (command === "update") {
    let package_name = "";
package_name = process.argv[3] || '';
    cmd_update(package_name);
    return 0;
}

    if (command === "search") {
    let query = "";
query = process.argv[3] || '';
    cmd_search(query);
    return 0;
}

    if (command === "doctor") {
    cmd_doctor();
    return 0;
}

    if (command === "contracts") {
const registry = ContractRegistry_new();
            ContractRegistry_list_interfaces(registry);
    return 0;
}

    if (command === "graph") {
    let input_file = "";
    let output_file = "";
input_file = process.argv[3] || '';
            output_file = process.argv[4] || '';
    if (input_file === "") {
    CLI_error("Usage: omni graph <input.omni> [output.md]");
    CLI_info("Generates architecture diagrams in Mermaid format");
    return 1;
}

    if (output_file === "") {
// const path = require('path'); (hoisted)
                output_file = path.basename(input_file, '.omni') + '_architecture.md';
}

    cmd_graph(input_file, output_file);
    return 0;
}

    if (command === "bootstrap") {
    cmd_bootstrap();
    return 0;
}

    if (command === "studio") {
    let port = 3000;
    let open_app = false;
for (let i = 3; i < process.argv.length; i++) {
                if (process.argv[i] === '--port' && process.argv[i + 1]) {
                    port = parseInt(process.argv[i + 1]);
                }
                if (process.argv[i] === '--app') {
                    open_app = true;
                }
                if (process.argv[i] === '--tui') {
                    // TUI mode - interactive terminal
                    cmd_tui();
                    return 0;
                }
            }
    cmd_studio(port, open_app);
    return 0;
}

    if (command === "ui") {
    cmd_tui();
    return 0;
}

    if (command === "package") {
    let target = "";
for (let i = 3; i < process.argv.length; i++) {
                if (process.argv[i] === '--app' && process.argv[i + 1]) {
                    target = process.argv[i + 1];
                }
            }
            
            // Default to current platform
            if (!target) {
                const platform = process.platform;
                if (platform === 'win32') target = 'windows';
                else if (platform === 'darwin') target = 'macos';
                else if (platform === 'linux') target = 'linux';
                else target = 'windows';
            }
    let config = AppConfig_default();
// const fs = require('fs'); (hoisted)
            // const path = require('path'); (hoisted)
            const configPath = path.join(process.cwd(), 'omni.config.json');
            
            if (fs.existsSync(configPath)) {
                const cfg = JSON.parse(fs.readFileSync(configPath, 'utf-8'));
                if (cfg.app) {
                    config.name = cfg.app.name || config.name;
                    config.version = cfg.app.version || config.version;
                    config.bundle_id = cfg.app.bundle_id || config.bundle_id;
                    config.description = cfg.app.description || config.description;
                }
            }
    cmd_package_app(target, config);
    return 0;
}

    if (command === "ingest") {
    let input_file = "";
    let output_file = "";
input_file = process.argv[3] || '';
            output_file = process.argv[4] || '';
    if (input_file === "") {
    CLI_error("Usage: omni ingest <legacy_file> <output.omni>");
    CLI_info("Transforms PHP, Java, Python, or JS code to Omni");
    return 1;
}

    if (output_file === "") {
// const path = require('path'); (hoisted)
                output_file = path.basename(input_file).replace(/\.[^.]+$/, '.omni');
}

    cmd_ingest(input_file, output_file);
    return 0;
}

    if (command === "run") {
    let run_file = "";
run_file = process.argv[3] || '';
    if (run_file === "") {
    CLI_error("Usage: omni run <file.omni>");
    return 1;
}

    CLI_info("VM Mode - Executing: " + run_file);
    let source = read_file(run_file);
    let l = new_lexer(source);
    let p = new_parser(l);
    let program = Parser_parse_program(p);
    let vm = OmniVM_new();
    OmniVM_run(vm, program);
    return 0;
}

    if (command === "build") {
    CLI_info("Building from omni.config.json...");
    return 0;
}

    if (command === "test-all") {
    CLI_banner();
    CLI_header("Testing All Examples");
// const fs = require('fs'); (hoisted)
            // const path = require('path'); (hoisted)
            
            // Find examples directory
            const possiblePaths = [
                path.join(process.cwd(), 'examples'),
                path.join(__dirname, '..', '..', 'examples'),
                path.join(__dirname, '..', 'examples')
            ];
            
            let examplesDir = null;
            for (const p of possiblePaths) {
                if (fs.existsSync(p)) {
                    examplesDir = p;
                    break;
                }
            }
            
            if (!examplesDir) {
                CLI_error("Examples directory not found");
                CLI_info("Run from project root: .\\omni test-all");
                return 1;
            }
            
            CLI_info("Examples directory: " + examplesDir);
            console.log("");
            
            // Get all .omni files
            const files = fs.readdirSync(examplesDir)
                .filter(f => f.endsWith('.omni'))
                .sort();
            
            CLI_info("Found " + files.length + " example files");
            console.log("");
            
            let passed = 0;
            let failed = 0;
            const failures = [];
            
            for (const file of files) {
                const filePath = path.join(examplesDir, file);
                const outputPath = path.join(examplesDir, file.replace('.omni', '.test.js'));
                
                try {
                    // Read and parse
                    const source = fs.readFileSync(filePath, 'utf-8');
                    const l = new_lexer(source);
                    const p = new_parser(l);
                    const program = Parser_parse_program(p);
                    
                    // Generate code
                    const gen = HybridCodeGenerator_new('js');
                    const code = HybridCodeGenerator_generate(gen, program);
                    
                    // Check if code was generated
                    if (code && code.length > 0) {
                        passed++;
                        console.log(CLI_COLORS().green + "  ✓ " + CLI_COLORS().reset + file);
                    } else {
                        failed++;
                        failures.push({ file, error: "Empty output" });
                        console.log(CLI_COLORS().red + "  ✗ " + CLI_COLORS().reset + file + CLI_COLORS().dim + " (empty output)" + CLI_COLORS().reset);
                    }
                } catch (e) {
                    failed++;
                    failures.push({ file, error: e.message });
                    console.log(CLI_COLORS().red + "  ✗ " + CLI_COLORS().reset + file + CLI_COLORS().dim + " (" + e.message.substring(0, 40) + ")" + CLI_COLORS().reset);
                }
            }
            
            console.log("");
            console.log("────────────────────────────────────────");
            console.log("Results: " + CLI_COLORS().green + passed + " passed" + CLI_COLORS().reset + ", " + 
                (failed > 0 ? CLI_COLORS().red + failed + " failed" + CLI_COLORS().reset : "0 failed"));
            console.log("");
            
            if (failed > 0) {
                CLI_warning("Some examples failed to compile");
                for (const f of failures) {
                    console.log(CLI_COLORS().dim + "  " + f.file + ": " + f.error + CLI_COLORS().reset);
                }
                return 1;
            } else {
                CLI_success("All examples compiled successfully!");
                return 0;
            }
    return 0;
}

    let show_help = false;
show_help = command === 'help' || command === '--help' || command === '-h';
    if ((command === "" || args_len) < 3) {
    CLI_info("Launching interactive mode...");
    cmd_tui();
    return 0;
}

    if (show_help) {
    CLI_banner();
    print("Commands:");
    print("  setup                          Install Omni globally");
    print("  run <file.omni>                Execute instantly via VM");
    print("  build                          Build from omni.config.json");
    print("  test-all                       Validate all examples compile");
    print("  package --self                 Create self-contained package");
    print("  <input> <output> [options]     Compile to target");
    print("");
    print("Options:");
    print("  --target <lang>     Target language (js, python, lua, c, rust)");
    print("  --package <path>    Load external language package (.omni-pkg)");
    print("  --framework <name>  Framework adapter (nextjs, laravel, android)");
    print("  --coverage          Show AST coverage report");
    print("  --version, -v       Show version");
    print("");
    print("Examples:");
console.log(CLI_COLORS.dim + "  omni run app.omni                       # Execute immediately" + CLI_COLORS.reset);
            console.log(CLI_COLORS.dim + "  omni app.omni app.js                    # Compile to JS" + CLI_COLORS.reset);
            console.log(CLI_COLORS.dim + "  omni app.omni dist/ --framework nextjs  # Generate Next.js" + CLI_COLORS.reset);
            console.log(CLI_COLORS.dim + "  omni setup                              # Install globally" + CLI_COLORS.reset);
    print("");
    return 0;
}

    let input_path = "";
    let output_path = "";
    let target_lang = "js";
    let package_path = "";
    let framework = "";
    let show_coverage = false;
input_path = process.argv[2];
        output_path = process.argv[3];
        
        for (let i = 4; i < process.argv.length; i++) {
            const arg = process.argv[i];
            if (arg === "--target" && (i + 1 < process.argv.length)) {
                target_lang = process.argv[++i];
            } else if (arg === "--package" && (i + 1 < process.argv.length)) {
                package_path = process.argv[++i];
            } else if (arg === "--framework" && (i + 1 < process.argv.length)) {
                framework = process.argv[++i];
            } else if (arg === "--coverage") {
                show_coverage = true;
            }
        }
    CLI_info("Compiling: " + input_path);
    CLI_info("Target: " + target_lang);
if (package_path) {
            // const fs = require('fs'); (hoisted)
            // const path = require('path'); (hoisted)
            
            if (fs.existsSync(package_path)) {
                CLI_info("Loading package: " + package_path);
                
                const grammarPath = fs.statSync(package_path).isDirectory() 
                    ? path.join(package_path, 'grammar.json')
                    : package_path;
                    
                if (fs.existsSync(grammarPath)) {
                    const targetDir = path.join(__dirname, '..', 'targets');
                    if (!fs.existsSync(targetDir)) {
                        fs.mkdirSync(targetDir, { recursive: true });
                    }
                    
                    const profile = JSON.parse(fs.readFileSync(grammarPath, 'utf-8'));
                    const profileName = profile.name || path.basename(package_path, '.omni-pkg');
                    fs.writeFileSync(
                        path.join(targetDir, profileName + '.json'),
                        JSON.stringify(profile, null, 2)
                    );
                    
                    target_lang = profileName;
                    CLI_success("Loaded profile: " + profileName);
                }
            } else {
                CLI_warning("Package not found: " + package_path);
            }
        }
    let source = read_file(input_path);
    let l = new_lexer(source);
    let p = new_parser(l);
    let program = Parser_parse_program(p);
    let gen = new_code_generator(target_lang);
if (framework) {
            gen.framework = framework;
        }
    let code = CodeGenerator_generate(gen, program);
if (show_coverage || gen.ast_node_count > 0) {
            const coverage = gen.ast_node_count > 0 
                ? (gen.generated_count / gen.ast_node_count * 100).toFixed(1)
                : 100;
            CLI_info("AST Coverage: " + coverage + "% (" + 
                gen.generated_count + "/" + gen.ast_node_count + " nodes)");
                
            if (coverage < 100) {
                CLI_warning("Some AST nodes were not generated");
            }
        }
    write_file(output_path, code);
    CLI_success("Output: " + output_path);
    CLI_success("Compiled successfully!");
}


// Entry Point
if (require.main === module) {
    main();
}



// Expose all exports globally
if (typeof global !== 'undefined') Object.assign(global, exports);
console.log('Bundle exports:', Object.keys(exports));
