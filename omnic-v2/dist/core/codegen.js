// Generated by Omni Compiler
"use strict";

const ast = require("./ast.js");
const token = require("./token.js");

class CodeGenerator {
  constructor(data = {}) {}
}

function new_code_generator() {
  return new CodeGenerator({});
}

function CodeGenerator_generate(self, program) {
  let output = "";
  if (program && program.statements) {
    for (const stmt of program.statements) {
      output = output + CodeGenerator_gen_statement(self, stmt) + "\n";
    }
  }
  return output;
}

function CodeGenerator_gen_statement(self, stmt) {
  if (stmt.kind === 10) {
    return CodeGenerator_gen_import(self, stmt);
  }

  if (stmt.kind === 80) {
    return stmt.code;
  }

  if (stmt.kind === NODE_LET) {
    return (
      "const " +
      stmt.name +
      " = " +
      CodeGenerator_gen_expression(self, stmt.value) +
      ";"
    );
  }

  if (stmt.kind === NODE_RETURN) {
    return "return " + CodeGenerator_gen_expression(self, stmt.value) + ";";
  }

  if (stmt.kind === NODE_FUNCTION) {
    let params = "";
    params = stmt.params.join(", ");
    const body = CodeGenerator_gen_block(self, stmt.body);
    return "function " + stmt.name + "(" + params + ") " + body;
  }

  if (stmt.kind === NODE_STRUCT) {
    return CodeGenerator_gen_struct(self, stmt);
  }

  if (stmt.kind === NODE_IF) {
    const cond = CodeGenerator_gen_expression(self, stmt.condition);
    const cons = CodeGenerator_gen_block(self, stmt.consequence);
    let alt = "";
    if (stmt.alternative) {
      alt = " else " + CodeGenerator_gen_block(self, stmt.alternative);
    }

    return "if (" + cond + ") " + cons + alt;
  }

  if (stmt.kind === 14) { // NODE_WHILE
    const cond = CodeGenerator_gen_expression(self, stmt.condition);
    const body = CodeGenerator_gen_block(self, stmt.body);
    return "while (" + cond + ") " + body;
  }

  if (stmt.expr) {
    return CodeGenerator_gen_expression(self, stmt.expr) + ";";
  }

  return "// Unknown stmt kind: " + stmt.kind;
}

function CodeGenerator_gen_import(self, stmt) {
  let path = stmt.path;
  path = path.replace(".omni", ".js");
  if (path.startsWith(".") == false) path = "./" + path;
  // Extrai nome do arquivo para vari├ível: "./core/token.js" -> "token"
  let name = path.split("/").pop().replace(".js", "");
  // Gera: const token = require("./token.js");
  return "const " + name + ' = require("' + path + '");';
  return "";
}

function CodeGenerator_gen_struct(self, stmt) {
  const name = stmt.name;
  let assignments = "";
  for (const field of stmt.fields) {
    assignments =
      assignments +
      "        this." +
      field.name +
      " = data." +
      field.name +
      ";\n";
  }
  return (
    "class " +
    name +
    " {\n    constructor(data = {}) {\n" +
    assignments +
    "    }\n}"
  );
}

function CodeGenerator_gen_block(self, block) {
  let out = "{\n";
  if (block && block.statements) {
    for (const s of block.statements) {
      out = out + "    " + CodeGenerator_gen_statement(self, s) + "\n";
    }
  }
  out = out + "}";
  return out;
}

function CodeGenerator_gen_expression(self, expr) {
  if (expr === 0) {
    return "null";
  }

  if (expr.kind === NODE_LITERAL) {
    return expr.value;
  }

  if (expr.kind === NODE_BINARY) {
    return (
      CodeGenerator_gen_expression(self, expr.left) +
      " " +
      expr.op +
      " " +
      CodeGenerator_gen_expression(self, expr.right)
    );
  }

  if (expr.kind === NODE_CALL) {
    let args = "";
    let list = [];
    for (let a of expr.args) list.push(CodeGenerator_gen_expression(self, a));
    args = list.join(", ");
    let is_class = false;
    let first = expr.function.charAt(0);
    is_class = first >= "A" && first <= "Z";
    if (is_class) {
      return "new " + expr.function + "(" + args + ")";
    }

    return expr.function + "(" + args + ")";
  }

  if (expr.kind === NODE_MEMBER) {
    return (
      CodeGenerator_gen_expression(self, expr.target) + "." + expr.property
    );
  }

  if (expr.kind === 12) {
    return "{}";
  }

  if (expr.kind === 11) {
    let elems = [];
    for (let e of expr.elements) elems.push(CodeGenerator_gen_expression(self, e));
    return "[" + elems.join(", ") + "]";
  }

  if (typeof expr == "string") return expr;
  return expr;
}




module.exports = { new_code_generator, CodeGenerator_generate, CodeGenerator_gen_statement, CodeGenerator_gen_import, CodeGenerator_gen_struct, CodeGenerator_gen_block, CodeGenerator_gen_expression, CodeGenerator };

Object.assign(global, ast);
Object.assign(global, token);
Object.assign(global, token);
