// Generated by Omni Compiler
'use strict';

const cli = require('../lib/cli.js');
const ghost_writer = require('./ghost_writer.js');

class ProjectInfo {
    constructor(data = {}) {
        this.name = data.name;
        this.type = data.type;
        this.config_file = data.config_file;
        this.run_command = data.run_command;
        this.build_command = data.build_command;
        this.dev_command = data.dev_command;
    }
}

function detect_project(dir) {
    let info = new ProjectInfo({ name: "", type: "unknown", config_file: "", run_command: "", build_command: "", dev_command: "" });
const fs = require('fs');
        const path = require('path');
        
        info.name = path.basename(dir);
        
        // Detection order (most specific first)
        const detectors = [
            {
                file: 'omni.config.json',
                type: 'omni',
                run: 'omni run main.omni',
                build: 'omni build',
                dev: 'omni studio'
            },
            {
                file: 'package.json',
                type: 'node',
                run: 'npm start',
                build: 'npm run build',
                dev: 'npm run dev'
            },
            {
                file: 'Cargo.toml',
                type: 'rust',
                run: 'cargo run',
                build: 'cargo build --release',
                dev: 'cargo watch -x run'
            },
            {
                file: 'composer.json',
                type: 'php',
                run: 'php artisan serve',
                build: 'composer install',
                dev: 'php artisan serve'
            },
            {
                file: 'requirements.txt',
                type: 'python',
                run: 'python main.py',
                build: 'pip install -r requirements.txt',
                dev: 'uvicorn app:main --reload'
            },
            {
                file: 'pyproject.toml',
                type: 'python',
                run: 'python -m app',
                build: 'pip install -e .',
                dev: 'uvicorn app:main --reload'
            },
            {
                file: 'go.mod',
                type: 'go',
                run: 'go run .',
                build: 'go build',
                dev: 'go run .'
            },
            {
                file: 'pom.xml',
                type: 'java',
                run: './mvnw spring-boot:run',
                build: './mvnw package',
                dev: './mvnw spring-boot:run'
            },
            {
                file: 'build.gradle',
                type: 'java',
                run: './gradlew bootRun',
                build: './gradlew build',
                dev: './gradlew bootRun'
            },
            {
                file: 'artisan',
                type: 'laravel',
                run: 'php artisan serve',
                build: 'composer install && npm run build',
                dev: 'php artisan serve'
            }
        ];
        
        for (const detector of detectors) {
            const configPath = path.join(dir, detector.file);
            if (fs.existsSync(configPath)) {
                info.type = detector.type;
                info.config_file = detector.file;
                info.run_command = detector.run;
                info.build_command = detector.build;
                info.dev_command = detector.dev;
                break;
            }
        }
    return info;
}

class CrossRunner {
    constructor(data = {}) {
        this.processes = data.processes;
        this.output_buffer = data.output_buffer;
    }
}

function CrossRunner_new() {
    return new CrossRunner({ processes: {  }, output_buffer: {  } });
}

function CrossRunner_run(self, name, command, cwd) {
    let success = true;
const { spawn } = require('child_process');
        const path = require('path');
        
        console.log(CLI_COLORS.cyan + "[runner] " + CLI_COLORS.reset + "Starting: " + command);
        
        // Parse command
        const parts = command.split(' ');
        const cmd = parts[0];
        const args = parts.slice(1);
        
        // Spawn process
        const proc = spawn(cmd, args, {
            cwd: cwd,
            shell: true,
            stdio: ['inherit', 'pipe', 'pipe']
        });
        
        self.processes[name] = proc;
        self.output_buffer[name] = [];
        
        proc.stdout.on('data', (data) => {
            const line = data.toString();
            self.output_buffer[name].push(line);
            process.stdout.write(CLI_COLORS.dim + "[" + name + "] " + CLI_COLORS.reset + line);
        });
        
        proc.stderr.on('data', (data) => {
            const line = data.toString();
            self.output_buffer[name].push(line);
            process.stderr.write(CLI_COLORS.red + "[" + name + "] " + CLI_COLORS.reset + line);
        });
        
        proc.on('close', (code) => {
            console.log(CLI_COLORS.yellow + "[runner] " + CLI_COLORS.reset + name + " exited with code " + code);
            delete self.processes[name];
        });
        
        proc.on('error', (err) => {
            CLI_error("Failed to start " + name + ": " + err.message);
            success = false;
        });
    return success;
}

function CrossRunner_stop(self, name) {
const proc = self.processes[name];
        if (proc) {
            proc.kill('SIGTERM');
            console.log(CLI_COLORS.yellow + "[runner] " + CLI_COLORS.reset + "Stopped: " + name);
        }
}

function CrossRunner_stop_all(self) {
for (const name of Object.keys(self.processes)) {
            CrossRunner_stop(self, name);
        }
}

class GraphNode {
    constructor(data = {}) {
        this.id = data.id;
        this.type = data.type;
        this.name = data.name;
        this.position = data.position;
        this.ports = data.ports;
        this.attributes = data.attributes;
        this.ast_ref = data.ast_ref;
    }
}

class GraphEdge {
    constructor(data = {}) {
        this.id = data.id;
        this.source = data.source;
        this.target = data.target;
        this.edge_type = data.edge_type;
    }
}

class GraphState {
    constructor(data = {}) {
        this.nodes = data.nodes;
        this.edges = data.edges;
        this.selected = data.selected;
        this.viewport = data.viewport;
    }
}

function GraphState_new() {
    return new GraphState({ nodes: [], edges: [], selected: [], viewport: { x: 0, y: 0, zoom: 1 } });
}

function GraphState_from_ast(program) {
    let state = GraphState_new();
if (!program || !program.statements) return;
        
        let nodeId = 0;
        let y = 50;
        
        for (const stmt of program.statements) {
            const node = {
                id: 'node_' + (++nodeId),
                type: 'unknown',
                name: stmt.name || 'anonymous',
                position: { x: 100, y: y },
                ports: { inputs: [], outputs: [] },
                attributes: stmt.attributes || [],
                ast_ref: { kind: stmt.kind, line: stmt.line || 0 }
            };
            
            // Determine type
            if (stmt.kind === 93) {
                node.type = 'capsule';
                node.position.x = 50;
                
                // Add flows as child nodes
                for (const flow of (stmt.flows || [])) {
                    y += 60;
                    state.nodes.push({
                        id: 'node_' + (++nodeId),
                        type: 'flow',
                        name: flow.name,
                        position: { x: 150, y: y },
                        ports: {
                            inputs: (flow.params || []).map((p, i) => ({
                                id: 'port_in_' + nodeId + '_' + i,
                                name: typeof p === 'string' ? p : p.name,
                                type: typeof p === 'object' ? p.type : 'any'
                            })),
                            outputs: [{
                                id: 'port_out_' + nodeId,
                                name: 'return',
                                type: flow.return_type || 'void'
                            }]
                        },
                        attributes: flow.attributes || [],
                        ast_ref: { kind: 94, line: flow.line || 0 },
                        parent: node.id
                    });
                }
            } else if (stmt.kind === 70) {
                node.type = 'entity';
                node.ports.outputs = (stmt.fields || []).map((f, i) => ({
                    id: 'port_field_' + nodeId + '_' + i,
                    name: typeof f === 'string' ? f : f.name,
                    type: typeof f === 'object' ? f.type : 'any'
                }));
            } else if (stmt.kind === 4) {
                node.type = 'function';
                node.ports.inputs = (stmt.params || []).map((p, i) => ({
                    id: 'port_in_' + nodeId + '_' + i,
                    name: typeof p === 'string' ? p : p.name,
                    type: typeof p === 'object' ? p.type : 'any'
                }));
                node.ports.outputs = [{
                    id: 'port_out_' + nodeId,
                    name: 'return',
                    type: stmt.return_type || 'void'
                }];
            }
            
            state.nodes.push(node);
            y += 100;
        }
    return state;
}

function GraphState_to_json(self) {
    let json = "";
json = JSON.stringify({
            nodes: self.nodes,
            edges: self.edges,
            viewport: self.viewport
        }, null, 2);
    return json;
}

class StudioServer {
    constructor(data = {}) {
        this.port = data.port;
        this.project = data.project;
        this.runner = data.runner;
        this.graph = data.graph;
    }
}

function StudioServer_new(port) {
    return new StudioServer({ port: port, project: new ProjectInfo({ name: "", type: "unknown", config_file: "", run_command: "", build_command: "", dev_command: "" }), runner: CrossRunner_new(), graph: GraphState_new() });
}

function StudioServer_start(self, dir) {
    CLI_banner();
    CLI_header("Omni Studio");
    self.project = detect_project(dir);
    CLI_info(("Project: " + self.project.name));
    CLI_info(("Type: " + self.project.type));
const http = require('http');
        const fs = require('fs');
        const path = require('path');
        
        const server = http.createServer((req, res) => {
            // API Routes
            if (req.url === '/api/project') {
                res.writeHead(200, { 'Content-Type': 'application/json' });
                res.end(JSON.stringify(self.project));
                return;
            }
            
            if (req.url === '/api/graph') {
                res.writeHead(200, { 'Content-Type': 'application/json' });
                res.end(GraphState_to_json(self.graph));
                return;
            }
            
            if (req.url === '/api/packages') {
                const registry = PackageRegistry_new();
                res.writeHead(200, { 'Content-Type': 'application/json' });
                res.end(JSON.stringify(registry.packages));
                return;
            }
            
            // Serve Studio UI
            if (req.url === '/' || req.url === '/index.html') {
                res.writeHead(200, { 'Content-Type': 'text/html' });
                res.end(generate_studio_html(self));
                return;
            }
            
            res.writeHead(404);
            res.end('Not Found');
        });
        
        server.listen(self.port, () => {
            console.log("");
            console.log(CLI_COLORS.green + "  ├óÔÇóÔÇØ├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇóÔÇö" + CLI_COLORS.reset);
            console.log(CLI_COLORS.green + "  ├óÔÇóÔÇÿ                                                ├óÔÇóÔÇÿ" + CLI_COLORS.reset);
            console.log(CLI_COLORS.green + "  ├óÔÇóÔÇÿ       OMNI STUDIO - Ready                      ├óÔÇóÔÇÿ" + CLI_COLORS.reset);
            console.log(CLI_COLORS.green + "  ├óÔÇóÔÇÿ                                                ├óÔÇóÔÇÿ" + CLI_COLORS.reset);
            console.log(CLI_COLORS.green + "  ├óÔÇó┼í├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬É├óÔÇó┬Ø" + CLI_COLORS.reset);
            console.log("");
            console.log(CLI_COLORS.cyan + "  ├óÔÇáÔÇÖ Local:   " + CLI_COLORS.reset + "http://localhost:" + self.port);
            console.log(CLI_COLORS.cyan + "  ├óÔÇáÔÇÖ Project: " + CLI_COLORS.reset + self.project.name);
            console.log("");
            CLI_info("Press Ctrl+C to stop");
        });
}

function generate_studio_html(server) {
    let html = "";
html = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omni Studio - ${server.project.name}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border: #30363d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --accent-blue: #58a6ff;
            --accent-green: #7ee787;
            --accent-purple: #a371f7;
            --accent-orange: #d29922;
            --accent-red: #f85149;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .header {
            background: var(--bg-secondary);
            padding: 10px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .logo { font-weight: bold; font-size: 18px; color: var(--accent-blue); }
        .project-info { color: var(--text-secondary); font-size: 14px; }
        .header-actions { margin-left: auto; display: flex; gap: 8px; }
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            border: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .btn-primary { background: #238636; color: white; }
        .btn-primary:hover { background: #2ea043; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-danger { background: #da3633; color: white; }
        
        .main { flex: 1; display: flex; overflow: hidden; }
        
        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        .sidebar-section { padding: 12px 16px; border-bottom: 1px solid var(--border); }
        .sidebar-title { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 8px; }
        .sidebar-item {
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 2px;
        }
        .sidebar-item:hover { background: var(--bg-tertiary); }
        .sidebar-item.active { background: var(--bg-tertiary); color: var(--accent-blue); }
        
        /* Node Palette */
        .node-palette { flex: 1; overflow-y: auto; }
        .palette-node {
            padding: 10px 12px;
            margin: 4px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: grab;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .palette-node:hover { border-color: var(--accent-blue); }
        .palette-node[data-type="capsule"] { border-left: 3px solid var(--accent-blue); }
        .palette-node[data-type="flow"] { border-left: 3px solid var(--accent-purple); }
        .palette-node[data-type="function"] { border-left: 3px solid var(--accent-orange); }
        .palette-node[data-type="entity"] { border-left: 3px solid var(--accent-green); }
        .palette-node[data-type="3d"] { border-left: 3px solid #ff6b6b; }
        
        /* Workspace */
        .workspace { flex: 1; display: flex; flex-direction: column; }
        .tabs { background: var(--bg-secondary); padding: 0 16px; display: flex; gap: 0; border-bottom: 1px solid var(--border); }
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            font-size: 13px;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
        }
        .tab:hover { color: var(--text-primary); }
        .tab.active { color: var(--accent-blue); border-bottom-color: var(--accent-blue); }
        
        /* Canvas */
        .canvas-container { flex: 1; position: relative; overflow: hidden; }
        #canvas {
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(var(--bg-primary) 1px, transparent 1px),
                linear-gradient(90deg, var(--bg-primary) 1px, transparent 1px);
            background-size: 20px 20px;
            background-color: #010409;
            position: relative;
        }
        
        /* Visual Nodes */
        .vnode {
            position: absolute;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 8px;
            min-width: 180px;
            cursor: move;
            user-select: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .vnode.selected { border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(88,166,255,0.3); }
        .vnode.capsule { border-color: var(--accent-blue); }
        .vnode.flow { border-color: var(--accent-purple); }
        .vnode.function { border-color: var(--accent-orange); }
        .vnode.entity { border-color: var(--accent-green); }
        .vnode-header {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .vnode-type { font-size: 9px; text-transform: uppercase; color: var(--text-secondary); }
        .vnode-title { font-weight: 600; font-size: 13px; }
        .vnode-body { padding: 8px 12px; font-size: 12px; }
        .vnode-port {
            padding: 4px 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .port-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--border);
            border: 2px solid var(--bg-tertiary);
        }
        .port-in .port-dot { background: var(--accent-green); }
        .port-out .port-dot { background: var(--accent-orange); }
        
        /* Editor Panel */
        .editor-panel { display: none; height: 100%; }
        .editor-panel.active { display: flex; flex-direction: column; }
        #code-editor {
            flex: 1;
            background: var(--bg-primary);
            padding: 16px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.5;
            overflow: auto;
            white-space: pre;
            color: var(--text-primary);
        }
        
        /* Terminal Panel */
        .terminal-container {
            height: 200px;
            background: #010409;
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        .terminal-tabs { display: flex; gap: 0; background: var(--bg-secondary); }
        .terminal-tab {
            padding: 8px 16px;
            font-size: 12px;
            cursor: pointer;
            color: var(--text-secondary);
            border-right: 1px solid var(--border);
        }
        .terminal-tab.active { background: #010409; color: var(--accent-green); }
        .terminal-tab .status { width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-left: 6px; }
        .terminal-tab .status.running { background: var(--accent-green); }
        .terminal-tab .status.stopped { background: var(--text-secondary); }
        #terminal-output {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        .terminal-line { padding: 2px 0; }
        .terminal-line.info { color: var(--accent-blue); }
        .terminal-line.success { color: var(--accent-green); }
        .terminal-line.error { color: var(--accent-red); }
        .terminal-line.warning { color: var(--accent-orange); }
        
        /* Right Panel - Cross-Runner */
        .right-panel {
            width: 280px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        .runner-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }
        .runner-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .runner-name { font-weight: 600; font-size: 13px; }
        .runner-status { font-size: 11px; padding: 2px 8px; border-radius: 4px; }
        .runner-status.running { background: rgba(126,231,135,0.2); color: var(--accent-green); }
        .runner-status.stopped { background: rgba(139,148,158,0.2); color: var(--text-secondary); }
        .runner-cmd { font-size: 11px; color: var(--text-secondary); font-family: monospace; }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">├óÔÇö┼á OMNI STUDIO</div>
        <div class="project-info">${server.project.name} <span style="color:var(--text-secondary)">(${server.project.type})</span></div>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="saveProject()">├░┼©ÔÇÖ┬¥ Save</button>
            <button class="btn btn-primary" onclick="runProject()">├óÔÇô┬Â Run</button>
            <button class="btn btn-secondary" onclick="buildProject()">├░┼©ÔÇ£┬ª Build</button>
            <button class="btn btn-secondary" onclick="openPreview()">├░┼©┼Æ┬É Preview</button>
        </div>
    </div>
    
    <div class="main">
        <!-- Left Sidebar -->
        <div class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Explorer</div>
                <div class="sidebar-item" onclick="loadFile('main.omni')">├░┼©ÔÇ£ÔÇ× main.omni</div>
                <div class="sidebar-item" onclick="loadFile('omni.config.json')">├ó┼íÔäó├»┬©┬Å omni.config.json</div>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">Node Palette</div>
            </div>
            
            <div class="node-palette">
                <div class="palette-node" data-type="capsule" draggable="true">├░┼©ÔÇ£┬ª Capsule</div>
                <div class="palette-node" data-type="flow" draggable="true">├ó┼í┬í Flow</div>
                <div class="palette-node" data-type="function" draggable="true">├åÔÇÖ Function</div>
                <div class="palette-node" data-type="entity" draggable="true">├░┼©ÔÇ£ÔÇ╣ Entity</div>
                <div class="palette-node" data-type="3d" draggable="true">├░┼©┼¢┬« 3D Scene</div>
                <div class="palette-node" data-type="3d" draggable="true">├░┼©┬º┼á 3D Cube</div>
                <div class="palette-node" data-type="3d" draggable="true">├░┼©ÔÇØ┬Á 3D Sphere</div>
                <div class="palette-node" data-type="3d" draggable="true">├░┼©ÔÇÖ┬í 3D Light</div>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">Packages</div>
                <div class="sidebar-item" onclick="showPackages()">├░┼©ÔÇ£┬ª Browse Registry</div>
            </div>
        </div>
        
        <!-- Workspace -->
        <div class="workspace">
            <div class="tabs">
                <div class="tab active" data-panel="graph" onclick="switchTab('graph')">├░┼©ÔÇØÔÇö Graph</div>
                <div class="tab" data-panel="editor" onclick="switchTab('editor')">├░┼©ÔÇ£┬Ø Editor</div>
                <div class="tab" data-panel="preview" onclick="switchTab('preview')">├░┼©ÔÇÿ┬ü Preview</div>
            </div>
            
            <div class="canvas-container">
                <div id="canvas"></div>
                <div class="editor-panel" id="editor-panel">
                    <div id="code-editor" contenteditable="true"></div>
                </div>
                <div class="editor-panel" id="preview-panel">
                    <iframe id="preview-frame" style="width:100%;height:100%;border:none;background:#fff"></iframe>
                </div>
            </div>
            
            <div class="terminal-container">
                <div class="terminal-tabs">
                    <div class="terminal-tab active">Output <span class="status running"></span></div>
                    <div class="terminal-tab">Problems</div>
                    <div class="terminal-tab">Debug</div>
                </div>
                <div id="terminal-output">
                    <div class="terminal-line info">├óÔÇö┼á Omni Studio v1.1.0</div>
                    <div class="terminal-line">Project: ${server.project.name}</div>
                    <div class="terminal-line">Ready to run: ${server.project.run_command}</div>
                </div>
            </div>
        </div>
        
        <!-- Right Panel - Cross-Runner -->
        <div class="right-panel">
            <div class="sidebar-section">
                <div class="sidebar-title">Cross-Runner</div>
            </div>
            
            <div class="runner-item">
                <div class="runner-header">
                    <span class="runner-name">Main Process</span>
                    <span class="runner-status stopped">Stopped</span>
                </div>
                <div class="runner-cmd">${server.project.run_command}</div>
            </div>
            
            <div class="runner-item">
                <div class="runner-header">
                    <span class="runner-name">Dev Server</span>
                    <span class="runner-status stopped">Stopped</span>
                </div>
                <div class="runner-cmd">${server.project.dev_command}</div>
            </div>
            
            <div class="sidebar-section" style="margin-top:auto">
                <button class="btn btn-secondary" style="width:100%" onclick="packageApp('windows')">├░┼©ÔÇ£┬ª Package Windows</button>
                <button class="btn btn-secondary" style="width:100%;margin-top:8px" onclick="packageApp('android')">├░┼©ÔÇ£┬▒ Package Android</button>
            </div>
        </div>
    </div>
    
    <script>
        let nodes = [];
        let selectedNode = null;
        let dragNode = null;
        let dragOffset = { x: 0, y: 0 };
        let codeContent = '';
        
        // Load initial graph
        async function loadGraph() {
            const res = await fetch('/api/graph');
            const graph = await res.json();
            nodes = graph.nodes || [];
            renderNodes();
        }
        
        function renderNodes() {
            const canvas = document.getElementById('canvas');
            canvas.innerHTML = '';
            
            for (const node of nodes) {
                const el = document.createElement('div');
                el.className = 'vnode ' + node.type;
                el.dataset.id = node.id;
                el.style.left = (node.position?.x || 100) + 'px';
                el.style.top = (node.position?.y || 100) + 'px';
                
                let portsHtml = '';
                if (node.ports?.inputs?.length) {
                    portsHtml += node.ports.inputs.map(p => 
                        '<div class="vnode-port port-in"><span class="port-dot"></span> ' + p.name + ': ' + p.type + '</div>'
                    ).join('');
                }
                if (node.ports?.outputs?.length) {
                    portsHtml += node.ports.outputs.map(p => 
                        '<div class="vnode-port port-out">' + p.name + ': ' + p.type + ' <span class="port-dot"></span></div>'
                    ).join('');
                }
                
                el.innerHTML = 
                    '<div class="vnode-header">' +
                        '<span class="vnode-type">' + node.type + '</span>' +
                        '<span class="vnode-title">' + node.name + '</span>' +
                    '</div>' +
                    '<div class="vnode-body">' + portsHtml + '</div>';
                
                el.addEventListener('mousedown', startDrag);
                el.addEventListener('click', selectNode);
                canvas.appendChild(el);
            }
        }
        
        function selectNode(e) {
            document.querySelectorAll('.vnode').forEach(n => n.classList.remove('selected'));
            e.currentTarget.classList.add('selected');
            selectedNode = nodes.find(n => n.id === e.currentTarget.dataset.id);
        }
        
        function startDrag(e) {
            dragNode = e.currentTarget;
            const rect = dragNode.getBoundingClientRect();
            dragOffset = { x: e.clientX - rect.left, y: e.clientY - rect.top };
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', stopDrag);
        }
        
        function onDrag(e) {
            if (!dragNode) return;
            const canvas = document.getElementById('canvas');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left - dragOffset.x;
            const y = e.clientY - rect.top - dragOffset.y;
            dragNode.style.left = x + 'px';
            dragNode.style.top = y + 'px';
            
            const node = nodes.find(n => n.id === dragNode.dataset.id);
            if (node) {
                node.position = { x, y };
            }
        }
        
        function stopDrag() {
            dragNode = null;
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', stopDrag);
            syncToServer();
        }
        
        // Palette drag & drop
        document.querySelectorAll('.palette-node').forEach(el => {
            el.addEventListener('dragstart', e => {
                e.dataTransfer.setData('nodeType', el.dataset.type);
            });
        });
        
        document.getElementById('canvas').addEventListener('dragover', e => e.preventDefault());
        document.getElementById('canvas').addEventListener('drop', e => {
            e.preventDefault();
            const type = e.dataTransfer.getData('nodeType');
            const rect = e.currentTarget.getBoundingClientRect();
            createNode(type, e.clientX - rect.left, e.clientY - rect.top);
        });
        
        function createNode(type, x, y) {
            const id = 'node_' + Date.now();
            const names = { capsule: 'NewCapsule', flow: 'newFlow', function: 'newFunction', entity: 'NewEntity', '3d': 'Scene3D' };
            nodes.push({
                id,
                type,
                name: names[type] || 'NewNode',
                position: { x, y },
                ports: { inputs: [], outputs: [{ id: 'out_' + id, name: 'return', type: 'void' }] },
                attributes: []
            });
            renderNodes();
            syncToServer();
            log('Created ' + type + ' node', 'success');
        }
        
        async function syncToServer() {
            await fetch('/api/graph/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nodes })
            });
        }
        
        function switchTab(panel) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.tab[data-panel="' + panel + '"]').classList.add('active');
            
            document.getElementById('canvas').style.display = panel === 'graph' ? 'block' : 'none';
            document.getElementById('editor-panel').classList.toggle('active', panel === 'editor');
            document.getElementById('preview-panel').classList.toggle('active', panel === 'preview');
        }
        
        function log(msg, type = '') {
            const output = document.getElementById('terminal-output');
            output.innerHTML += '<div class="terminal-line ' + type + '">> ' + msg + '</div>';
            output.scrollTop = output.scrollHeight;
        }
        
        async function runProject() {
            log('Running: ${server.project.run_command}', 'info');
            await fetch('/api/run', { method: 'POST' });
        }
        
        async function buildProject() {
            log('Building project...', 'info');
            await fetch('/api/build', { method: 'POST' });
        }
        
        function openPreview() {
            document.getElementById('preview-frame').src = 'http://localhost:${server.port + 1}';
            switchTab('preview');
        }
        
        async function saveProject() {
            log('Saving project...', 'info');
            await fetch('/api/save', { method: 'POST', body: JSON.stringify({ nodes }) });
            log('Project saved!', 'success');
        }
        
        function packageApp(target) {
            log('Packaging for ' + target + '...', 'info');
            fetch('/api/package?target=' + target, { method: 'POST' });
        }
        
        function showPackages() {
            log('Opening package registry...', 'info');
        }
        
        loadGraph();
    </script>
</body>
</html>`;
    return html;
}

function cmd_studio(port, open_app) {
    let cwd = "";
cwd = process.cwd();
    let server = StudioServer_new(port);
const fs = require('fs');
        const path = require('path');
        
        const mainFiles = ['main.omni', 'src/main.omni', 'app.omni'];
        for (const file of mainFiles) {
            const fullPath = path.join(cwd, file);
            if (fs.existsSync(fullPath)) {
                CLI_info("Loading: " + file);
                
                // Parse and create graph
                const source = fs.readFileSync(fullPath, 'utf-8');
                const lexer = new_lexer(source);
                const parser = new_parser(lexer);
                const program = Parser_parse_program(parser);
                
                server.graph = GraphState_from_ast(program);
                CLI_success("Graph generated: " + server.graph.nodes.length + " nodes");
                break;
            }
        }
    if (open_app) {
    CLI_info("Opening native app (requires Tauri)...");
const { exec } = require('child_process');
            const url = 'http://localhost:' + port;
            
            // Try to open browser as fallback
            const cmd = process.platform === 'win32' ? 'start' :
                        process.platform === 'darwin' ? 'open' : 'xdg-open';
            exec(cmd + ' ' + url);
}

    StudioServer_start(server, cwd);
}

