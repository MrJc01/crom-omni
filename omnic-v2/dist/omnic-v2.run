#!/bin/bash
# ================================================================
# omnic-v2.run - Self-Extracting Omni Package
# Generated by Omni Compiler
# ================================================================

set -e

# Check for Node.js
if ! command -v node &> /dev/null; then
    echo "[omni] Node.js is required but not installed."
    echo "[omni] Install: https://nodejs.org/"
    exit 1
fi

# Create temp directory
TMPDIR=$(mktemp -d)
trap "rm -rf $TMPDIR" EXIT

# Extract embedded code
echo "[omni] Extracting omnic-v2..."
echo 'Ly8gPT09IGNsaWVudC5qcyA9PT0KY29uc3QgbW9kZWxzID0gcmVxdWlyZSgiLi9zaGFyZWQvbW9kZWxzLmpzIik7CmlmICh0eXBlb2YgZ2xvYmFsICE9PSAndW5kZWZpbmVkJykgT2JqZWN0LmFzc2lnbihnbG9iYWwsIG1vZGVscyk7CmZ1bmN0aW9uIGRpc3BsYXlfdXNlcih1c2VyKSB7CiAgICBwcmludCgiVXNlcjogIiArIHVzZXIubmFtZSArICIgKCIgKyB1c2VyLmVtYWlsICsgIikiKTsKfQpmdW5jdGlvbiBtYWluKCkgewogICAgcHJpbnQoIkNsaWVudCBzdGFydGluZy4uLiIpOwogICAgbGV0IHVzZXIgPSBjcmVhdGVfdXNlcig0MiwgIkFsaWNlIiwgImFsaWNlQGV4YW1wbGUuY29tIik7CiAgICBkaXNwbGF5X3VzZXIodXNlcik7Cn0KCgovLyA9PT0gbW9kZWxzLmpzID09PQpjbGFzcyBVc2VyIHsKICAgIGNvbnN0cnVjdG9yKGRhdGEgPSB7fSkgewogICAgICAgIHRoaXMuaWQgPSBkYXRhLmlkOwogICAgICAgIHRoaXMubmFtZSA9IGRhdGEubmFtZTsKICAgICAgICB0aGlzLmVtYWlsID0gZGF0YS5lbWFpbDsKICAgIH0KfQoKY2xhc3MgTWVzc2FnZSB7CiAgICBjb25zdHJ1Y3RvcihkYXRhID0ge30pIHsKICAgICAgICB0aGlzLmlkID0gZGF0YS5pZDsKICAgICAgICB0aGlzLnVzZXJfaWQgPSBkYXRhLnVzZXJfaWQ7CiAgICAgICAgdGhpcy5jb250ZW50ID0gZGF0YS5jb250ZW50OwogICAgfQp9CgpmdW5jdGlvbiBjcmVhdGVfdXNlcihpZCwgbmFtZSwgZW1haWwpIHsKICAgIHJldHVybiBuZXcgVXNlcih7IGlkOiBpZCwgbmFtZTogbmFtZSwgZW1haWw6IGVtYWlsIH0pOwp9Cgptb2R1bGUuZXhwb3J0cyA9IHsgVXNlciwgTWVzc2FnZSwgY3JlYXRlX3VzZXIgfTsKCgo=' | base64 -d > "$TMPDIR/app.js"

# Extract migrations
echo 'LS0gR2VuZXJhdGVkIGJ5IE9tbmkgQ29tcGlsZXIgKGRpYWxlY3Q6IHBvc3RncmVzKQoKLS0gVGFibGU6IFVzZXIKQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgVXNlciAoCiAgICBpZCBTRVJJQUwgUFJJTUFSWSBLRVksCiAgICBuYW1lIFZBUkNIQVIoMjU1KSwKICAgIGVtYWlsIFZBUkNIQVIoMjU1KQopOwoKLS0gVGFibGU6IFBvc3QKQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgUG9zdCAoCiAgICBpZCBTRVJJQUwgUFJJTUFSWSBLRVksCiAgICB1c2VyX2lkIElOVEVHRVIsCiAgICB0aXRsZSBWQVJDSEFSKDI1NSksCiAgICBjb250ZW50IFZBUkNIQVIoMjU1KSwKICAgIEZPUkVJR04gS0VZICh1c2VyX2lkKSBSRUZFUkVOQ0VTIFVzZXIoaWQpCik7CgotLSBUYWJsZTogQ29tbWVudApDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyBDb21tZW50ICgKICAgIGlkIFNFUklBTCBQUklNQVJZIEtFWSwKICAgIHBvc3RfaWQgSU5URUdFUiwKICAgIHVzZXJfaWQgSU5URUdFUiwKICAgIHRleHQgVkFSQ0hBUigyNTUpLAogICAgRk9SRUlHTiBLRVkgKHBvc3RfaWQpIFJFRkVSRU5DRVMgUG9zdChpZCksCiAgICBGT1JFSUdOIEtFWSAodXNlcl9pZCkgUkVGRVJFTkNFUyBVc2VyKGlkKQopOwoKLS0gVGFibGU6IFByb2R1Y3QKQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgUHJvZHVjdCAoCiAgICBpZCBTRVJJQUwgUFJJTUFSWSBLRVksCiAgICBuYW1lIFZBUkNIQVIoMjU1KSwKICAgIHByaWNlIERPVUJMRSBQUkVDSVNJT04sCiAgICBpbl9zdG9jayBCT09MRUFOCik7CgotLSBUYWJsZTogT3JkZXIKQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgT3JkZXIgKAogICAgaWQgU0VSSUFMIFBSSU1BUlkgS0VZLAogICAgcHJvZHVjdF9pZCBCSUdJTlQsCiAgICBxdWFudGl0eSBJTlRFR0VSLAogICAgdG90YWwgRE9VQkxFIFBSRUNJU0lPTgopOwoK' | base64 -d > "$TMPDIR/migrations.sql"

# Show migrations
echo "[omni] Migrations:"
cat "$TMPDIR/migrations.sql"

# Run
echo "[omni] Starting omnic-v2..."
cd "$TMPDIR"
node app.js "$@"
