/**
 * Node.js Bundler for Omni Compiler
 * Clean version
 */

const fs = require('fs');
const path = require('path');

const distDir = 'dist';

// Module order (codegen_hybrid_impl removed, handled manually)
const coreModules = ['token', 'lexer', 'parser', 'ast', 'codegen', 'codegen_hybrid', 'vm', 'framework_adapter', 'ingestion', 'package_manager', 'contracts', 'ghost_writer', 'bootstrap', 'studio_engine', 'studio_graph', 'app_packager', 'tui'];
const libModules = ['std', 'terminal'];
const cmdModules = ['cmd_setup', 'cmd_run', 'cmd_build', 'cmd_test', 'cmd_package', 'cmd_registry', 'cmd_studio'];

// Header
let bundle = `'use strict';
// Omni Compiler Bundle
// Global Header: Core Node.js dependencies
const path = require('path');
const fs = require('fs');
const { execSync } = require('child_process');
const http = require('http');
const https = require('https');
const readline = require('readline');
const child_process = require('child_process'); // Expose full module


`;

function appendModule(filePath) {
    if (!fs.existsSync(filePath)) {
        console.log(`[WARN] File not found: ${filePath}`);
        return '';
    }
    
    let content = fs.readFileSync(filePath, 'utf8');
    content = content.replace(/\r/g, ''); // Normalize
    
    const lines = content.split('\n');
    const filtered = [];
    
    for (const line of lines) {
        // Rewrite import of codegen_hybrid_impl to use the bundled variable
        if (line.includes("require") && line.includes("codegen_hybrid_impl")) {
             console.log("[BUNDLE] Linked codegen_hybrid_impl in " + path.basename(filePath));
             filtered.push("const impl = codegen_hybrid_impl;");
             continue;
        }

        // Skip other requires
        if (/^\s*(const|let|var)\s+\w+\s*=\s*require\s*\(/.test(line)) {
            continue;
        }
        
        // Skip directives and headers
        if (/'use strict'/.test(line)) continue;
        if (/^\/\/ Generated by Omni/.test(line)) continue;
        if (/Object\.assign\s*\(\s*global/.test(line)) continue;
        
        filtered.push(line);
    }
    
    return '\n' + filtered.join('\n') + '\n';
}

function appendRaw(filePath) {
    if (!fs.existsSync(filePath)) return '';
    let content = fs.readFileSync(filePath, 'utf8');
    content = content.replace(/\r/g, '');
    
    const lines = content.split('\n');
    const filtered = [];
    for (const line of lines) {
        // Skip require lines
        if (/^\s*(const|let|var)\s+\w+\s*=\s*require\s*\(/.test(line)) continue;
        // Skip module.exports lines (not needed in bundle)
        if (line.includes('module.exports')) continue;
        filtered.push(line);
    }
    return '\n' + filtered.join('\n') + '\n';
}

// Load in order
console.log('Bundling...');

// 1. Append codegen_hybrid_impl (Native JS)
bundle += appendRaw(path.join(distDir, 'core', 'codegen_hybrid_impl.js'));

// 2. Append Core Modules
for (const m of coreModules) {
    bundle += appendModule(path.join(distDir, 'core', `${m}.js`));
}

// 3. Append Libs and Commands
for (const m of libModules) {
    bundle += appendModule(path.join(distDir, 'lib', `${m}.js`));
}
for (const m of cmdModules) {
    bundle += appendModule(path.join(distDir, 'commands', `${m}.js`));
}

// 4. Append Main
bundle += appendModule(path.join(distDir, 'main.js'));

// Failsafe cleanup
bundle = bundle.replace(/if\s*\(typeof\s+global\s*!==\s*'undefined'\)\s*Object\.assign\(\s*global\s*,\s*_\w+\s*\);?\r?\n?/g, '');

fs.writeFileSync(path.join(distDir, 'omni_bundle.js'), bundle, 'utf8');
console.log(`Done: ${path.join(distDir, 'omni_bundle.js')} (${bundle.length} bytes)`);
